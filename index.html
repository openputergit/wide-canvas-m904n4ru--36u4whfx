<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .task-card {
            transition: all 0.3s ease;
        }
        .task-card:hover {
            transform: translateY(-5px);
        }
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            height: 20px;
            width: 20px;
            background-color: #ef4444;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.7rem;
        }
        .excel-table {
            border-collapse: collapse;
        }
        .excel-table th, .excel-table td {
            border: 1px solid #e5e7eb;
            padding: 8px;
        }
        .chart-container {
            width: 100%;
            height: 300px;
            position: relative;
        }
        .bar {
            position: absolute;
            bottom: 40px;
            width: 40px;
            background-color: #3b82f6;
            border-radius: 4px 4px 0 0;
            transition: height 0.5s ease;
        }
        .bar-label {
            position: absolute;
            bottom: 0;
            width: 40px;
            text-align: center;
            font-size: 12px;
            padding: 5px 0;
        }
        .value-label {
            position: absolute;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
            width: 40px;
            margin-top: -20px;
        }
        .comment-section {
            max-height: 300px;
            overflow-y: auto;
        }
        .calendar {
            border-collapse: separate;
            border-spacing: 2px;
        }
        .calendar th {
            text-align: center;
            padding: 5px;
        }
        .calendar td {
            width: 14.28%;
            padding: 5px;
            height: 100px;
            vertical-align: top;
        }
        .calendar .date {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        .calendar .task-item {
            font-size: 11px;
            background-color: #e5edff;
            padding: 2px 4px;
            border-radius: 3px;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
        }
        .task-item.high {
            background-color: #fef3c7;
        }
        .task-item.urgent {
            background-color: #fee2e2;
        }
        .employee-tag {
            display: inline-block;
            margin-right: 5px;
            margin-bottom: 5px;
            padding: 2px 6px;
            border-radius: 12px;
            background-color: #e5edff;
            font-size: 12px;
        }
        .employee-tag .remove-tag {
            margin-left: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="loginSection" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Task Management System</h2>
            <div class="mb-4">
                <div class="flex justify-center space-x-4 mb-4">
                    <button id="adminLoginBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 w-full">Admin Login</button>
                    <button id="employeeLoginBtn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300 w-full">Employee Login</button>
                </div>
            </div>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-gray-700">Email</label>
                    <input type="email" id="email" class="w-full p-2 border rounded" required>
                </div>
                <div>
                    <label class="block text-gray-700">Password</label>
                    <input type="password" id="password" class="w-full p-2 border rounded" required>
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Login</button>
                <button type="button" id="googleLoginBtn" class="w-full bg-white border border-gray-300 p-2 rounded hover:bg-gray-50 flex items-center justify-center mt-4">
                    <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M23.745 12.27c0-.79-.07-1.54-.19-2.27h-11.3v4.51h6.47c-.29 1.48-1.14 2.73-2.4 3.58v3h3.86c2.26-2.09 3.56-5.17 3.56-8.82z"/>
                        <path fill="#34A853" d="M12.255 24c3.24 0 5.95-1.08 7.93-2.91l-3.86-3c-1.08.72-2.45 1.16-4.07 1.16-3.13 0-5.78-2.11-6.73-4.96h-3.98v3.09c1.97 3.92 6.02 6.62 10.71 6.62z"/>
                        <path fill="#FBBC05" d="M5.525 14.29c-.25-.72-.38-1.49-.38-2.29s.14-1.57.38-2.29v-3.09h-3.98c-.8 1.61-1.26 3.43-1.26 5.38s.46 3.77 1.26 5.38l3.98-3.09z"/>
                        <path fill="#EA4335" d="M12.255 5.04c1.77 0 3.35.61 4.6 1.8l3.42-3.42c-2.07-1.94-4.78-3.13-8.02-3.13-4.69 0-8.74 2.7-10.71 6.62l3.98 3.09c.95-2.85 3.6-4.96 6.73-4.96z"/>
                    </svg>
                    Sign in with Google
                </button>
                <div class="text-center text-sm mt-4">
                    <span class="text-gray-600">Don't have an account?</span>
                    <button type="button" id="showSignupBtn" class="text-blue-500 hover:underline ml-1">Sign up</button>
                </div>
            </form>
        </div>
    </div>

    <div id="signupSection" class="min-h-screen flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Create Account</h2>
            <form id="signupForm" class="space-y-4">
                <div>
                    <label class="block text-gray-700">Full Name</label>
                    <input type="text" id="signupName" class="w-full p-2 border rounded" required>
                </div>
                <div>
                    <label class="block text-gray-700">Company Name</label>
                    <input type="text" id="companyName" class="w-full p-2 border rounded" required>
                </div>
                <div>
                    <label class="block text-gray-700">Email</label>
                    <input type="email" id="signupEmail" class="w-full p-2 border rounded" required>
                </div>
                <div>
                    <label class="block text-gray-700">Password</label>
                    <input type="password" id="signupPassword" class="w-full p-2 border rounded" required>
                </div>
                <div>
                    <label class="block text-gray-700">Confirm Password</label>
                    <input type="password" id="confirmPassword" class="w-full p-2 border rounded" required>
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Create Admin Account</button>
                <button type="button" id="googleSignupBtn" class="w-full bg-white border border-gray-300 p-2 rounded hover:bg-gray-50 flex items-center justify-center mt-4">
                    <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M23.745 12.27c0-.79-.07-1.54-.19-2.27h-11.3v4.51h6.47c-.29 1.48-1.14 2.73-2.4 3.58v3h3.86c2.26-2.09 3.56-5.17 3.56-8.82z"/>
                        <path fill="#34A853" d="M12.255 24c3.24 0 5.95-1.08 7.93-2.91l-3.86-3c-1.08.72-2.45 1.16-4.07 1.16-3.13 0-5.78-2.11-6.73-4.96h-3.98v3.09c1.97 3.92 6.02 6.62 10.71 6.62z"/>
                        <path fill="#FBBC05" d="M5.525 14.29c-.25-.72-.38-1.49-.38-2.29s.14-1.57.38-2.29v-3.09h-3.98c-.8 1.61-1.26 3.43-1.26 5.38s.46 3.77 1.26 5.38l3.98-3.09z"/>
                        <path fill="#EA4335" d="M12.255 5.04c1.77 0 3.35.61 4.6 1.8l3.42-3.42c-2.07-1.94-4.78-3.13-8.02-3.13-4.69 0-8.74 2.7-10.71 6.62l3.98 3.09c.95-2.85 3.6-4.96 6.73-4.96z"/>
                    </svg>
                    Sign up with Google
                </button>
                <div class="text-center text-sm mt-4">
                    <span class="text-gray-600">Already have an account?</span>
                    <button type="button" id="showLoginBtn" class="text-blue-500 hover:underline ml-1">Log in</button>
                </div>
            </form>
        </div>
    </div>

    <div id="masterDashboard" class="hidden">
        <nav class="bg-purple-600 text-white p-4">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-xl font-bold">Master Dashboard</h1>
                <div class="flex space-x-2">
                    <button onclick="logout()" class="bg-red-500 px-4 py-1 rounded hover:bg-red-600">Logout</button>
                </div>
            </div>
        </nav>

        <div class="container mx-auto p-6">
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Admin Accounts Management</h2>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full excel-table">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="text-left py-3 px-4">Admin Name</th>
                                <th class="text-left py-3 px-4">Email</th>
                                <th class="text-left py-3 px-4">Company</th>
                                <th class="text-left py-3 px-4">Total Employees</th>
                                <th class="text-left py-3 px-4">Total Tasks</th>
                                <th class="text-left py-3 px-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminAccountsTable">
                            <!-- Admin accounts will be dynamically added here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="adminEmployeesSection" class="bg-white p-6 rounded-lg shadow mt-6 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="viewingCompanyTitle" class="text-xl font-bold">Employees for Company</h2>
                    <button onclick="hideAdminEmployeesSection()" class="bg-gray-300 px-4 py-1 rounded hover:bg-gray-400">
                        <i class="bi bi-x"></i> Close
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full excel-table">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="text-left py-3 px-4">Name</th>
                                <th class="text-left py-3 px-4">Email</th>
                                <th class="text-left py-3 px-4">Password</th>
                                <th class="text-left py-3 px-4">Position</th>
                                <th class="text-left py-3 px-4">Department</th>
                                <th class="text-left py-3 px-4">Assigned Tasks</th>
                            </tr>
                        </thead>
                        <tbody id="adminEmployeesTable">
                            <!-- Employees for selected admin will be dynamically added here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="adminDashboard" class="hidden">
        <nav class="bg-blue-600 text-white p-4">
            <div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
                <h1 class="text-xl font-bold">Admin Dashboard</h1>
                <div class="flex flex-wrap space-x-2 space-y-2 md:space-y-0 mt-2 md:mt-0">
                    <button onclick="showAdminSection('taskManagement')" class="bg-blue-700 px-3 py-1 rounded hover:bg-blue-800">Task Management</button>
                    <button onclick="showAdminSection('employeeList')" class="bg-blue-700 px-3 py-1 rounded hover:bg-blue-800">Employees</button>
                    <button onclick="showAdminSection('analytics')" class="bg-blue-700 px-3 py-1 rounded hover:bg-blue-800">Analytics</button>
                    <button onclick="showAdminSection('emailScraper')" class="bg-blue-700 px-3 py-1 rounded hover:bg-blue-800">Email Scraper</button>
                    <button onclick="showAdminSection('calendar')" class="bg-blue-700 px-3 py-1 rounded hover:bg-blue-800">Calendar</button>
                    <div class="relative">
                        <button onclick="toggleNotifications()" class="bg-blue-700 px-3 py-1 rounded hover:bg-blue-800">
                            <i class="bi bi-bell"></i>
                            <span id="notificationBadge" class="notification-badge hidden">0</span>
                        </button>
                        <div id="notificationsDropdown" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-md shadow-lg z-10">
                            <div class="p-3 border-b">
                                <h3 class="text-gray-700 font-semibold">Notifications</h3>
                            </div>
                            <div id="notificationsList" class="max-h-64 overflow-y-auto p-2">
                                <!-- Notifications will be added here -->
                                <p class="text-gray-500 text-sm p-2">No new notifications</p>
                            </div>
                        </div>
                    </div>
                    <button onclick="emailDailySummary()" class="bg-green-600 px-3 py-1 rounded hover:bg-green-700">
                        <i class="bi bi-envelope"></i> Email Summary
                    </button>
                    <button onclick="logout()" class="bg-red-500 px-4 py-1 rounded hover:bg-red-600">Logout</button>
                </div>
            </div>
        </nav>

        <div id="taskManagementSection" class="container mx-auto p-6">
            <div class="bg-white p-4 rounded-lg shadow mb-6">
                <h2 class="text-xl font-bold mb-4">AI Work Summary</h2>
                <div id="aiSummary" class="p-4 bg-blue-50 rounded">
                    <p class="text-gray-700">Loading AI summary...</p>
                </div>
            </div>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Assign New Task</h2>
                    <form id="taskForm" class="space-y-4">
                        <div>
                            <label class="block text-gray-700">Department</label>
                            <div class="flex">
                                <select id="department" class="flex-grow p-2 border rounded-l" required>
                                    <option value="">Select a department</option>
                                </select>
                                <button type="button" onclick="showDepartmentModal()" class="bg-blue-500 text-white p-2 rounded-r hover:bg-blue-600">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-gray-700">Employees</label>
                            <div class="flex">
                                <select id="employeeSelect" class="flex-grow p-2 border rounded">
                                    <option value="">Select employee(s)</option>
                                </select>
                                <button type="button" onclick="addEmployeeToTask()" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600 ml-2">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                            <div id="selectedEmployees" class="mt-2 flex flex-wrap"></div>
                            <input type="hidden" id="employeeIds" name="employeeIds">
                        </div>
                        <div>
                            <label class="block text-gray-700">Task Title</label>
                            <input type="text" id="taskTitle" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label class="block text-gray-700">Task Description</label>
                            <textarea id="taskDesc" class="w-full p-2 border rounded" rows="3" required></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700">Hours Allocation</label>
                            <input type="number" id="hours" class="w-full p-2 border rounded" min="1" required>
                        </div>
                        <div>
                            <label class="block text-gray-700">Deadline</label>
                            <input type="datetime-local" id="deadline" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label class="block text-gray-700">Frequency</label>
                            <select id="frequency" class="w-full p-2 border rounded">
                                <option value="once">Once</option>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monday">Every Monday</option>
                                <option value="tuesday">Every Tuesday</option>
                                <option value="wednesday">Every Wednesday</option>
                                <option value="thursday">Every Thursday</option>
                                <option value="friday">Every Friday</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700">Priority</label>
                            <select id="priority" class="w-full p-2 border rounded">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="sendReminder" class="mr-2">
                            <label for="sendReminder" class="text-gray-700">Send reminder</label>
                        </div>
                        <button type="submit" class="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600">
                            Assign Task
                        </button>
                    </form>
                </div>

                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Task Overview</h2>
                        <div class="flex flex-wrap gap-2">
                            <select id="statusFilter" class="p-2 border rounded text-sm">
                                <option value="all">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="in-progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="overdue">Overdue</option>
                                <option value="revision-requested">Revision Requested</option>
                            </select>
                            <select id="departmentFilter" class="p-2 border rounded text-sm">
                                <option value="all">All Departments</option>
                            </select>
                            <select id="employeeFilter" class="p-2 border rounded text-sm">
                                <option value="all">All Employees</option>
                            </select>
                            <select id="priorityFilter" class="p-2 border rounded text-sm">
                                <option value="all">All Priorities</option>
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                    </div>
                    <div id="taskList" class="space-y-4 max-h-[600px] overflow-y-auto">
                        <!-- Tasks will be dynamically added here -->
                        <p class="text-center text-gray-500 p-4">No tasks yet</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="employeeListSection" class="container mx-auto p-6 hidden">
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Employee Management</h2>
                    <button onclick="toggleAddEmployeeForm()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        <i class="bi bi-plus"></i> Add New Employee
                    </button>
                </div>
                
                <div id="addEmployeeForm" class="mb-6 hidden bg-gray-50 p-4 rounded">
                    <h3 class="font-semibold mb-2">Add New Employee</h3>
                    <form id="newEmployeeForm" class="space-y-3">
                        <input type="hidden" id="editingEmpId" value="">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm">Full Name</label>
                                <input type="text" id="empName" class="w-full p-2 border rounded" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm">Email</label>
                                <input type="email" id="empEmail" class="w-full p-2 border rounded" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm">Password</label>
                                <input type="password" id="empPassword" class="w-full p-2 border rounded" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm">Position</label>
                                <input type="text" id="empPosition" class="w-full p-2 border rounded" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm">Department</label>
                                <select id="empDepartment" class="w-full p-2 border rounded" required>
                                    <option value="">Select a department</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button type="button" onclick="toggleAddEmployeeForm()" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">Cancel</button>
                            <button type="submit" id="saveEmployeeBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Add Employee</button>
                        </div>
                    </form>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full excel-table">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="text-left py-3 px-4">Name</th>
                                <th class="text-left py-3 px-4">Email</th>
                                <th class="text-left py-3 px-4">Position</th>
                                <th class="text-left py-3 px-4">Department</th>
                                <th class="text-left py-3 px-4">Tasks</th>
                                <th class="text-left py-3 px-4">Completion Rate</th>
                                <th class="text-left py-3 px-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="employeeTableBody">
                            <!-- Employee list will be dynamically added here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="analyticsSection" class="container mx-auto p-6 hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Task Completion Rates by Employee</h2>
                    <div class="chart-container" id="completionRateChart">
                        <!-- Chart will be dynamically populated here -->
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Hours Allocation vs Completion</h2>
                    <div class="chart-container" id="hoursChart">
                        <!-- Chart will be dynamically populated here -->
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Department Performance</h2>
                    <div class="chart-container" id="departmentChart">
                        <!-- Department chart will be dynamically populated here -->
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Priority Distribution</h2>
                    <div class="chart-container" id="priorityChart">
                        <!-- Priority chart will be dynamically populated here -->
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow md:col-span-2">
                    <h2 class="text-xl font-bold mb-4">Employee Performance Summary</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full excel-table">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="text-left py-3 px-4">Employee</th>
                                    <th class="text-left py-3 px-4">Department</th>
                                    <th class="text-left py-3 px-4">Assigned Tasks</th>
                                    <th class="text-left py-3 px-4">Completed Tasks</th>
                                    <th class="text-left py-3 px-4">Completion Rate</th>
                                    <th class="text-left py-3 px-4">Avg. Time to Complete</th>
                                    <th class="text-left py-3 px-4">On-time Rate</th>
                                    <th class="text-left py-3 px-4">Revision Requests</th>
                                </tr>
                            </thead>
                            <tbody id="performanceSummaryTable">
                                <!-- Performance data will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="emailScraperSection" class="container mx-auto p-6 hidden">
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-bold mb-4">Email Scraper Tool</h2>
                <div class="mb-6">
                    <h3 class="font-semibold mb-2">Upload Excel File</h3>
                    <p class="text-sm text-gray-500 mb-3">Upload an Excel file containing URLs to LinkedIn profiles or webpages to extract emails.</p>
                    <div class="flex items-center space-x-2">
                        <label for="excelFile" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 cursor-pointer">
                            <i class="bi bi-upload"></i> Upload Excel
                        </label>
                        <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" class="hidden">
                        <span id="fileName" class="text-sm text-gray-500">No file selected</span>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h3 class="font-semibold mb-2">Manual URL Entry</h3>
                    <div class="flex">
                        <input type="url" id="manualUrl" placeholder="Enter LinkedIn URL or webpage" class="flex-grow p-2 border rounded-l">
                        <button onclick="scrapeUrl()" class="bg-blue-500 text-white px-4 py-2 rounded-r hover:bg-blue-600">Scrape</button>
                    </div>
                </div>
                
                <div>
                    <h3 class="font-semibold mb-2">Results</h3>
                    <div class="bg-gray-50 p-4 rounded min-h-[200px] max-h-[400px] overflow-y-auto">
                        <table class="min-w-full excel-table">
                            <thead>
                                <tr>
                                    <th class="text-left">URL</th>
                                    <th class="text-left">Email</th>
                                    <th class="text-left">Name</th>
                                    <th class="text-left">Status</th>
                                </tr>
                            </thead>
                            <tbody id="scrapingResults">
                                <tr>
                                    <td colspan="4" class="text-center text-gray-500 p-4">Results will appear here</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="flex justify-end mt-4 space-x-2">
                        <button id="exportCsv" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                            <i class="bi bi-file-earmark-spreadsheet"></i> Export CSV
                        </button>
                        <button id="clearResults" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">
                            <i class="bi bi-trash"></i> Clear Results
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="calendarSection" class="container mx-auto p-6 hidden">
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Task Calendar</h2>
                    <div class="flex space-x-2">
                        <button onclick="changeMonth(-1)" class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <span id="currentMonthYear" class="font-medium">June 2023</span>
                        <button onclick="changeMonth(1)" class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="calendar w-full">
                        <thead>
                            <tr>
                                <th>Sunday</th>
                                <th>Monday</th>
                                <th>Tuesday</th>
                                <th>Wednesday</th>
                                <th>Thursday</th>
                                <th>Friday</th>
                                <th>Saturday</th>
                            </tr>
                        </thead>
                        <tbody id="calendarBody">
                            <!-- Calendar will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="employeeDashboard" class="hidden">
        <nav class="bg-green-600 text-white p-4">
            <div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
                <h1 class="text-xl font-bold">Employee Dashboard</h1>
                <div class="flex items-center space-x-4 mt-2 md:mt-0">
                    <span id="employeeNameDisplay" class="font-medium"></span>
                    <button onclick="showEmployeeSection('tasks')" class="bg-green-700 px-3 py-1 rounded hover:bg-green-800">My Tasks</button>
                    <button onclick="showEmployeeSection('calendar')" class="bg-green-700 px-3 py-1 rounded hover:bg-green-800">Calendar</button>
                    <div class="relative">
                        <button onclick="toggleEmployeeNotifications()" class="bg-green-700 px-3 py-1 rounded hover:bg-green-800">
                            <i class="bi bi-bell"></i>
                            <span id="employeeNotificationBadge" class="notification-badge hidden">0</span>
                        </button>
                        <div id="employeeNotificationsDropdown" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-md shadow-lg z-10">
                            <div class="p-3 border-b">
                                <h3 class="text-gray-700 font-semibold">Notifications</h3>
                            </div>
                            <div id="employeeNotificationsList" class="max-h-64 overflow-y-auto p-2">
                                <!-- Notifications will be added here -->
                                <p class="text-gray-500 text-sm p-2">No new notifications</p>
                            </div>
                        </div>
                    </div>
                    <button onclick="emailDailySummary()" class="bg-blue-600 px-3 py-1 rounded hover:bg-blue-700">
                        <i class="bi bi-envelope"></i> Email Summary
                    </button>
                    <button onclick="logout()" class="bg-red-500 px-4 py-1 rounded hover:bg-red-600">Logout</button>
                </div>
            </div>
        </nav>

        <div id="employeeTasksSection" class="container mx-auto p-6">
            <div class="mb-6 bg-white p-4 rounded-lg shadow">
                <h2 class="text-xl font-bold mb-2">AI Work Summary</h2>
                <div id="employeeAiSummary" class="p-4 bg-green-50 rounded">
                    <p class="text-gray-700">Loading AI summary...</p>
                </div>
            </div>
            
            <div class="mb-6 bg-white p-4 rounded-lg shadow">
                <h2 class="text-xl font-bold mb-2">My Tasks</h2>
                <div class="flex space-x-2 mb-4 flex-wrap">
                    <button onclick="filterEmployeeTasks('all')" class="px-3 py-1 bg-blue-500 text-white rounded">All</button>
                    <button onclick="filterEmployeeTasks('pending')" class="px-3 py-1 bg-gray-200 rounded">Pending</button>
                    <button onclick="filterEmployeeTasks('in-progress')" class="px-3 py-1 bg-gray-200 rounded">In Progress</button>
                    <button onclick="filterEmployeeTasks('completed')" class="px-3 py-1 bg-gray-200 rounded">Completed</button>
                    <button onclick="filterEmployeeTasks('revision-requested')" class="px-3 py-1 bg-gray-200 rounded">Revision Requested</button>
                    <select id="empPriorityFilter" onchange="filterEmployeeTasksByPriority()" class="px-3 py-1 bg-gray-200 rounded ml-auto">
                        <option value="all">All Priorities</option>
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                <div id="employeeTasks" class="grid md:grid-cols-3 gap-6">
                    <!-- Employee tasks will be dynamically added here -->
                    <p class="text-gray-500 col-span-3 text-center p-4">No tasks assigned yet</p>
                </div>
            </div>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-white p-4 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-2">Today's Schedule</h2>
                    <div id="todaySchedule" class="space-y-2">
                        <!-- Today's schedule will be dynamically added here -->
                        <p class="text-gray-500 text-center p-4">No tasks scheduled for today</p>
                    </div>
                </div>
                
                <div class="bg-white p-4 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-2">Performance</h2>
                    <div class="space-y-4">
                        <div>
                            <h3 class="font-semibold mb-1">Task Completion Rate</h3>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="completionRate" class="bg-green-600 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                            <p class="text-sm text-gray-600 mt-1"><span id="completionRateText">0%</span> tasks completed on time</p>
                        </div>
                        
                        <div>
                            <h3 class="font-semibold mb-1">Hours Allocation</h3>
                            <div class="flex justify-between text-sm">
                                <p>Assigned: <span id="totalHours">0</span> hours</p>
                                <p>Completed: <span id="completedHours">0</span> hours</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="employeeCalendarSection" class="container mx-auto p-6 hidden">
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">My Task Calendar</h2>
                    <div class="flex space-x-2">
                        <button onclick="changeEmployeeMonth(-1)" class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <span id="employeeCurrentMonthYear" class="font-medium">June 2023</span>
                        <button onclick="changeEmployeeMonth(1)" class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="calendar w-full">
                        <thead>
                            <tr>
                                <th>Sunday</th>
                                <th>Monday</th>
                                <th>Tuesday</th>
                                <th>Wednesday</th>
                                <th>Thursday</th>
                                <th>Friday</th>
                                <th>Saturday</th>
                            </tr>
                        </thead>
                        <tbody id="employeeCalendarBody">
                            <!-- Calendar will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Task details modal -->
    <div id="taskModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h2 id="modalTaskTitle" class="text-xl font-bold">Task Details</h2>
                    <button onclick="closeTaskModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                <div id="taskModalContent">
                    <!-- Task details will be populated here -->
                </div>
                <div id="taskModalComments" class="mt-6">
                    <h3 class="font-semibold mb-2">Comments</h3>
                    <div id="commentsList" class="comment-section border rounded p-3 mb-3 space-y-3">
                        <!-- Comments will be populated here -->
                    </div>
                    <form id="commentForm" class="mt-3">
                        <textarea id="commentText" placeholder="Add a comment..." class="w-full p-2 border rounded" rows="2" required></textarea>
                        <div class="flex justify-end mt-2">
                            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                Post Comment
                            </button>
                        </div>
                    </form>
                </div>
                <div id="taskRevisionRequest" class="mt-4 hidden">
                    <h3 class="font-semibold mb-2">Request Timeline Revision</h3>
                    <form id="revisionForm">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                            <div>
                                <label class="block text-gray-700 text-sm">New Deadline</label>
                                <input type="datetime-local" id="newDeadline" class="w-full p-2 border rounded" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm">Reason for Revision</label>
                                <select id="revisionReason" class="w-full p-2 border rounded" required>
                                    <option value="">Select a reason</option>
                                    <option value="scope expanded">Scope Expanded</option>
                                    <option value="technical issues">Technical Issues</option>
                                    <option value="resource constraints">Resource Constraints</option>
                                    <option value="dependencies delayed">Dependencies Delayed</option>
                                    <option value="other">Other (specify in comments)</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button type="submit" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
                                Request Revision
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Department modal -->
    <div id="departmentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-xl font-bold">Manage Departments</h2>
                    <button onclick="closeDepartmentModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                <form id="departmentForm" class="mb-4">
                    <div class="flex">
                        <input type="text" id="newDepartmentName" class="flex-grow p-2 border rounded-l" placeholder="Department name" required>
                        <button type="submit" class="bg-blue-500 text-white p-2 rounded-r hover:bg-blue-600">Add</button>
                    </div>
                </form>
                <div class="max-h-60 overflow-y-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="text-left p-2">Department Name</th>
                                <th class="text-right p-2">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="departmentsList">
                            <!-- Departments will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar task modal -->
    <div id="calendarTaskModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="calendarTaskDate" class="text-xl font-bold">Tasks for June 15, 2023</h2>
                    <button onclick="closeCalendarTaskModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                <div id="calendarTasksList" class="max-h-[50vh] overflow-y-auto">
                    <!-- Tasks will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize localStorage if first time use
        if (!localStorage.getItem('taskManagementUsers')) {
            // Default users
            const defaultUsers = {
                'admin@task.com': { password: 'Byebye@123', role: 'admin', name: 'Admin User', companyId: 'default' },
                'master@task.com': { password: 'Byebye@123', role: 'master', name: 'Master User' }
            };
            localStorage.setItem('taskManagementUsers', JSON.stringify(defaultUsers));
        } else {
            // Check if master user exists, add if not
            const users = JSON.parse(localStorage.getItem('taskManagementUsers'));
            if (!users['master@task.com']) {
                users['master@task.com'] = { password: 'Byebye@123', role: 'master', name: 'Master User' };
                localStorage.setItem('taskManagementUsers', JSON.stringify(users));
            }
        }

        if (!localStorage.getItem('taskManagementEmployees')) {
            const defaultEmployees = [
                { id: 'emp1', name: 'John Doe', email: 'john@example.com', password: 'pass123', position: 'Developer', department: 'Engineering', companyId: 'default' },
                { id: 'emp2', name: 'Jane Smith', email: 'jane@example.com', password: 'pass123', position: 'Designer', department: 'Design', companyId: 'default' },
                { id: 'emp3', name: 'Mike Johnson', email: 'mike@example.com', password: 'pass123', position: 'Project Manager', department: 'Management', companyId: 'default' }
            ];
            localStorage.setItem('taskManagementEmployees', JSON.stringify(defaultEmployees));
            
            // Add employees to users
            const users = JSON.parse(localStorage.getItem('taskManagementUsers'));
            defaultEmployees.forEach(emp => {
                users[emp.email] = { password: emp.password, role: 'employee', name: emp.name, id: emp.id, companyId: emp.companyId };
            });
            localStorage.setItem('taskManagementUsers', JSON.stringify(users));
        }

        if (!localStorage.getItem('taskManagementTasks')) {
            const defaultTasks = [
                {
                    id: 1,
                    employees: ['emp1'],
                    title: 'Create homepage design',
                    description: 'Design the homepage layout for the new website',
                    hours: 8,
                    deadline: '2023-06-15T17:00',
                    frequency: 'once',
                    priority: 'high',
                    status: 'completed',
                    createdAt: '2023-06-10T10:00',
                    completedAt: '2023-06-15T14:00',
                    department: 'Engineering',
                    companyId: 'default',
                    comments: [
                        {
                            id: 101,
                            author: 'Admin User',
                            authorEmail: 'admin@task.com',
                            text: 'Please make sure to follow the brand guidelines.',
                            timestamp: '2023-06-10T11:00'
                        },
                        {
                            id: 102,
                            author: 'John Doe',
                            authorEmail: 'john@example.com',
                            text: 'Design completed as requested. Please review.',
                            timestamp: '2023-06-15T14:00'
                        }
                    ]
                },
                {
                    id: 2,
                    employees: ['emp2'],
                    title: 'Fix login bug',
                    description: 'Debug and fix the login issue on the mobile app',
                    hours: 4,
                    deadline: '2023-06-20T12:00',
                    frequency: 'once',
                    priority: 'urgent',
                    status: 'in-progress',
                    createdAt: '2023-06-12T14:00',
                    department: 'Design',
                    companyId: 'default',
                    comments: []
                },
                {
                    id: 3,
                    employees: ['emp3', 'emp1'],
                    title: 'Weekly team meeting',
                    description: 'Conduct weekly team meeting to discuss project progress',
                    hours: 1,
                    deadline: '2023-06-16T10:00',
                    frequency: 'weekly',
                    priority: 'medium',
                    status: 'pending',
                    createdAt: '2023-06-13T09:00',
                    department: 'Management',
                    companyId: 'default',
                    comments: []
                }
            ];
            localStorage.setItem('taskManagementTasks', JSON.stringify(defaultTasks));
        } else {
            // Migrate old tasks format to new format with employees array
            const oldTasks = JSON.parse(localStorage.getItem('taskManagementTasks'));
            const updatedTasks = oldTasks.map(task => {
                if (!task.employees && task.employee) {
                    return {...task, employees: [task.employee]};
                }
                // Add companyId if missing
                if (!task.companyId) {
                    return {...task, companyId: 'default'};
                }
                return task;
            });
            localStorage.setItem('taskManagementTasks', JSON.stringify(updatedTasks));
        }

        if (!localStorage.getItem('taskManagementNotifications')) {
            localStorage.setItem('taskManagementNotifications', JSON.stringify([]));
        }

        if (!localStorage.getItem('taskManagementRevisions')) {
            localStorage.setItem('taskManagementRevisions', JSON.stringify([]));
        }

        if (!localStorage.getItem('taskManagementDepartments')) {
            const defaultDepartments = [
                { name: 'Engineering', companyId: 'default' },
                { name: 'Design', companyId: 'default' },
                { name: 'Management', companyId: 'default' },
                { name: 'Marketing', companyId: 'default' },
                { name: 'Sales', companyId: 'default' }
            ];
            localStorage.setItem('taskManagementDepartments', JSON.stringify(defaultDepartments));
        } else {
            // Migrate old departments format to include companyId
            const oldDepartments = JSON.parse(localStorage.getItem('taskManagementDepartments'));
            if (oldDepartments.length > 0 && typeof oldDepartments[0] === 'string') {
                const updatedDepartments = oldDepartments.map(dept => ({
                    name: dept,
                    companyId: 'default'
                }));
                localStorage.setItem('taskManagementDepartments', JSON.stringify(updatedDepartments));
            }
        }

        if (!localStorage.getItem('taskManagementCompanies')) {
            const defaultCompanies = [
                { id: 'default', name: 'Default Company' }
            ];
            localStorage.setItem('taskManagementCompanies', JSON.stringify(defaultCompanies));
        }

        // Get data from localStorage
        let users = JSON.parse(localStorage.getItem('taskManagementUsers'));
        let employees = JSON.parse(localStorage.getItem('taskManagementEmployees'));
        let tasks = JSON.parse(localStorage.getItem('taskManagementTasks'));
        let notifications = JSON.parse(localStorage.getItem('taskManagementNotifications'));
        let revisions = JSON.parse(localStorage.getItem('taskManagementRevisions')) || [];
        let departments = JSON.parse(localStorage.getItem('taskManagementDepartments')) || [];
        let companies = JSON.parse(localStorage.getItem('taskManagementCompanies')) || [];
        
        let currentUser = null;
        let currentLoginType = 'admin'; // Default to admin login
        
        // Check if user was logged in
        if (localStorage.getItem('currentUser')) {
            currentUser = JSON.parse(localStorage.getItem('currentUser'));
            showDashboard();
        }
        
        let editingTaskId = null;
        let currentTaskId = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedEmployees = [];
        let viewingCompanyId = null;

        // DOM Ready
        document.addEventListener('DOMContentLoaded', function() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Signup form
            document.getElementById('signupForm').addEventListener('submit', handleSignup);

            // Show signup/login section buttons
            document.getElementById('showSignupBtn').addEventListener('click', toggleAuthForms);
            document.getElementById('showLoginBtn').addEventListener('click', toggleAuthForms);

            // Switch between admin and employee login
            document.getElementById('adminLoginBtn').addEventListener('click', function() {
                currentLoginType = 'admin';
                toggleLoginButtons('admin');
            });
            
            document.getElementById('employeeLoginBtn').addEventListener('click', function() {
                currentLoginType = 'employee';
                toggleLoginButtons('employee');
            });

            // Google Auth buttons
            document.getElementById('googleLoginBtn').addEventListener('click', handleGoogleAuth);
            document.getElementById('googleSignupBtn').addEventListener('click', handleGoogleAuth);
            
            // Task form
            document.getElementById('taskForm').addEventListener('submit', handleTaskSubmission);
            
            // New employee form
            document.getElementById('newEmployeeForm').addEventListener('submit', handleNewEmployee);
            
            // Department form
            document.getElementById('departmentForm').addEventListener('submit', handleNewDepartment);
            
            // Excel file upload
            document.getElementById('excelFile').addEventListener('change', handleFileUpload);
            
            // Export button
            document.getElementById('exportCsv').addEventListener('click', exportToCsv);
            
            // Clear results button
            document.getElementById('clearResults').addEventListener('click', clearScrapingResults);

            // Status filter
            document.getElementById('statusFilter').addEventListener('change', filterTasks);
            
            // Employee filter
            document.getElementById('employeeFilter').addEventListener('change', filterTasks);
            
            // Department filter
            document.getElementById('departmentFilter').addEventListener('change', filterTasks);
            
            // Priority filter
            document.getElementById('priorityFilter').addEventListener('change', filterTasks);

            // Comment form
            document.getElementById('commentForm').addEventListener('submit', handleNewComment);

            // Revision form
            document.getElementById('revisionForm').addEventListener('submit', handleRevisionRequest);
            
            // Initialize login buttons
            toggleLoginButtons('admin');
        });

        function toggleLoginButtons(type) {
            const adminBtn = document.getElementById('adminLoginBtn');
            const employeeBtn = document.getElementById('employeeLoginBtn');
            
            if (type === 'admin') {
                adminBtn.classList.remove('bg-gray-200', 'text-gray-700');
                adminBtn.classList.add('bg-blue-500', 'text-white');
                
                employeeBtn.classList.remove('bg-blue-500', 'text-white');
                employeeBtn.classList.add('bg-gray-200', 'text-gray-700');
            } else {
                adminBtn.classList.remove('bg-blue-500', 'text-white');
                adminBtn.classList.add('bg-gray-200', 'text-gray-700');
                
                employeeBtn.classList.remove('bg-gray-200', 'text-gray-700');
                employeeBtn.classList.add('bg-blue-500', 'text-white');
            }
        }

        function toggleAuthForms() {
            const loginSection = document.getElementById('loginSection');
            const signupSection = document.getElementById('signupSection');
            
            if (loginSection.classList.contains('hidden')) {
                // Show login
                loginSection.classList.remove('hidden');
                signupSection.classList.add('hidden');
            } else {
                // Show signup
                loginSection.classList.add('hidden');
                signupSection.classList.remove('hidden');
            }
        }

        function handleSignup(e) {
            e.preventDefault();
            
            const name = document.getElementById('signupName').value;
            const companyName = document.getElementById('companyName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (password !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }
            
            // Check if email already exists
            if (users[email]) {
                alert('An account with this email already exists!');
                return;
            }
            
            // Create a new company
            const companyId = 'comp_' + Date.now().toString();
            companies.push({
                id: companyId,
                name: companyName
            });
            
            localStorage.setItem('taskManagementCompanies', JSON.stringify(companies));
            
            // Create new admin user account
            users[email] = {
                password: password,
                role: 'admin',
                name: name,
                companyId: companyId
            };
            
            localStorage.setItem('taskManagementUsers', JSON.stringify(users));
            
            alert('Admin account created successfully! You can now log in.');
            
            // Switch to login form
            toggleAuthForms();
        }

        function handleGoogleAuth() {
            alert('In a real implementation, this would authenticate with Google. For this demo, please use the standard login form.');
        }

        function showDashboard() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('signupSection').classList.add('hidden');
            
            if (currentUser.role === 'master') {
                document.getElementById('masterDashboard').classList.remove('hidden');
                updateAdminAccountsTable();
            } else if (currentUser.role === 'admin') {
                document.getElementById('adminDashboard').classList.remove('hidden');
                showAdminSection('taskManagement');
                updateTaskList();
                updateEmployeeTable();
                populateEmployeeDropdowns();
                populateDepartmentDropdowns();
                updateAdminNotifications();
                updateCalendar();
                generateAiSummary();
            } else {
                document.getElementById('employeeDashboard').classList.remove('hidden');
                showEmployeeSection('tasks');
                document.getElementById('employeeNameDisplay').textContent = currentUser.name;
                displayEmployeeTasks();
                updateEmployeePerformance();
                updateEmployeeNotifications(currentUser.email);
                updateEmployeeCalendar();
                generateEmployeeAiSummary();
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (users[email] && users[email].password === password) {
                // Special handling for master user
                if (users[email].role === 'master') {
                    currentUser = { email, ...users[email] };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showDashboard();
                    return;
                }
                
                // Check if login type matches user role for non-master users
                if (currentLoginType === 'admin' && users[email].role !== 'admin') {
                    alert('This is an employee account. Please use the employee login option.');
                    return;
                } else if (currentLoginType === 'employee' && users[email].role !== 'employee') {
                    alert('This is an admin account. Please use the admin login option.');
                    return;
                }
                
                currentUser = { email, ...users[email] };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showDashboard();
            } else {
                alert('Invalid credentials!');
            }
        }

        function updateAdminAccountsTable() {
            const tableBody = document.getElementById('adminAccountsTable');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            // Get all admin users
            const adminUsers = Object.entries(users)
                .filter(([_, user]) => user.role === 'admin')
                .map(([email, user]) => ({
                    email,
                    name: user.name,
                    companyId: user.companyId
                }));
            
            adminUsers.forEach(admin => {
                const company = companies.find(c => c.id === admin.companyId);
                const companyName = company ? company.name : 'Unknown Company';
                
                // Count employees for this company
                const companyEmployees = employees.filter(emp => emp.companyId === admin.companyId);
                
                // Count tasks for this company
                const companyTasks = tasks.filter(task => task.companyId === admin.companyId);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-3 px-4">${admin.name}</td>
                    <td class="py-3 px-4">${admin.email}</td>
                    <td class="py-3 px-4">${companyName}</td>
                    <td class="py-3 px-4">${companyEmployees.length}</td>
                    <td class="py-3 px-4">${companyTasks.length}</td>
                    <td class="py-3 px-4">
                        <button onclick="viewCompanyEmployees('${admin.companyId}', '${companyName}')" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">
                            <i class="bi bi-people"></i> View Employees
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function viewCompanyEmployees(companyId, companyName) {
            viewingCompanyId = companyId;
            
            // Update section title
            document.getElementById('viewingCompanyTitle').textContent = `Employees for ${companyName}`;
            
            // Show the employees section
            document.getElementById('adminEmployeesSection').classList.remove('hidden');
            
            // Populate the employees table
            const tableBody = document.getElementById('adminEmployeesTable');
            tableBody.innerHTML = '';
            
            // Get all employees for this company
            const companyEmployees = employees.filter(emp => emp.companyId === companyId);
            
            if (companyEmployees.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" class="py-3 px-4 text-center text-gray-500">No employees found for this company</td>
                `;
                tableBody.appendChild(row);
                return;
            }
            
            companyEmployees.forEach(emp => {
                // Count assigned tasks
                const assignedTasks = tasks.filter(task => 
                    task.employees && 
                    task.employees.includes(emp.id) && 
                    task.companyId === companyId
                );
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-3 px-4">${emp.name}</td>
                    <td class="py-3 px-4">${emp.email}</td>
                    <td class="py-3 px-4">${emp.password}</td>
                    <td class="py-3 px-4">${emp.position}</td>
                    <td class="py-3 px-4">${emp.department || 'Not assigned'}</td>
                    <td class="py-3 px-4">${assignedTasks.length}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function hideAdminEmployeesSection() {
            document.getElementById('adminEmployeesSection').classList.add('hidden');
            viewingCompanyId = null;
        }

        function addEmployeeToTask() {
            const employeeSelect = document.getElementById('employeeSelect');
            const selectedId = employeeSelect.value;
            
            if (!selectedId) return;
            
            // Get employee details
            const employee = employees.find(emp => emp.id === selectedId);
            if (!employee) return;
            
            // Check if employee already added
            if (selectedEmployees.some(emp => emp.id === selectedId)) {
                alert('This employee is already added to the task.');
                return;
            }
            
            selectedEmployees.push(employee);
            updateSelectedEmployeesTags();
            document.getElementById('employeeIds').value = JSON.stringify(selectedEmployees.map(emp => emp.id));
        }

        function removeEmployeeFromTask(empId) {
            selectedEmployees = selectedEmployees.filter(emp => emp.id !== empId);
            updateSelectedEmployeesTags();
            document.getElementById('employeeIds').value = JSON.stringify(selectedEmployees.map(emp => emp.id));
        }

        function updateSelectedEmployeesTags() {
            const container = document.getElementById('selectedEmployees');
            container.innerHTML = '';
            
            selectedEmployees.forEach(emp => {
                const tag = document.createElement('div');
                tag.className = 'employee-tag';
                tag.innerHTML = `${emp.name} <span class="remove-tag" onclick="removeEmployeeFromTask('${emp.id}')"></span>`;
                container.appendChild(tag);
            });
        }

        function handleTaskSubmission(e) {
            e.preventDefault();
            
            if (selectedEmployees.length === 0) {
                alert('Please select at least one employee for the task.');
                return;
            }
            
            const taskData = {
                employees: selectedEmployees.map(emp => emp.id),
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDesc').value,
                hours: parseInt(document.getElementById('hours').value),
                deadline: document.getElementById('deadline').value,
                frequency: document.getElementById('frequency').value,
                priority: document.getElementById('priority').value,
                department: document.getElementById('department').value,
                sendReminder: document.getElementById('sendReminder').checked,
                companyId: currentUser.companyId
            };
            
            if (editingTaskId) {
                // Update existing task
                const taskIndex = tasks.findIndex(t => t.id === editingTaskId);
                if (taskIndex !== -1) {
                    // Preserve existing comments and other metadata
                    const existingTask = tasks[taskIndex];
                    const updatedTask = {
                        ...existingTask,
                        ...taskData,
                        comments: existingTask.comments || []
                    };
                    tasks[taskIndex] = updatedTask;
                    localStorage.setItem('taskManagementTasks', JSON.stringify(tasks));
                    
                    // Add notification for all assigned employees
                    selectedEmployees.forEach(emp => {
                        notifications.push({
                            id: Date.now() + Math.random(),
                            user: emp.email,
                            message: `Task "${taskData.title}" has been updated by admin`,
                            timestamp: new Date().toISOString(),
                            read: false,
                            taskId: editingTaskId,
                            companyId: currentUser.companyId
                        });
                        
                        updateEmployeeNotifications(emp.email);
                    });
                    
                    localStorage.setItem('taskManagementNotifications', JSON.stringify(notifications));
                    
                    alert('Task updated successfully!');
                    editingTaskId = null;
                }
            } else {
                // Create new task
                const task = {
                    id: Date.now(),
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    comments: [],
                    ...taskData
                };
                
                tasks.push(task);
                localStorage.setItem('taskManagementTasks', JSON.stringify(tasks));
                
                // Add notification for all assigned employees
                selectedEmployees.forEach(emp => {
                    notifications.push({
                        id: Date.now() + Math.random(),
                        user: emp.email,
                        message: `New task assigned: ${task.title}`,
                        timestamp: new Date().toISOString(),
                        read: false,
                        taskId: task.id,
                        companyId: currentUser.companyId
                    });
                    
                    updateEmployeeNotifications(emp.email);
                });
                
                localStorage.setItem('taskManagementNotifications', JSON.stringify(notifications));
                
                alert('Task assigned successfully!');
            }
            
            // Clear selected employees
            selectedEmployees = [];
            updateSelectedEmployeesTags();
            
            updateTaskList();
            updateEmployeeTable(); // Update employee table to reflect new task
            updateCalendar(); // Update calendar
            generateAiSummary(); // Update AI summary
            document.getElementById('taskForm').reset();
        }

        function handleNewEmployee(e) {
            e.preventDefault();
            
            const name = document.getElementById('empName').value;
            const email = document.getElementById('empEmail').value;
            const password = document.getElementById('empPassword').value;
            const position = document.getElementById('empPosition').value;
            const department = document.getElementById('empDepartment').value;
            const editingId = document.getElementById('editingEmpId').value;
            
            // Check if email already exists (only for new employees)
            if (!editingId && users[email]) {
                alert('An employee with this email already exists!');
                return;
            }
            
            if (editingId) {
                // Update existing employee
                const index = employees.findIndex(emp => emp.id === editingId);
                if (index !== -1) {
                    // Save old email to update user entry
                    const oldEmail = employees[index].email;
                    
                    // Update employee data
                    employees[index] = {
                        id: editingId,
                        name,
                        email,
                        password,
                        position,
                        department,
                        companyId: currentUser.companyId
                    };
                    
                    // Remove old email from users
                    if (oldEmail !== email) {
                        delete users[oldEmail];
                    }
                    
                    // Add updated email to users
                    users[email] = { 
                        password, 
                        role: 'employee', 
                        name, 
                        id: editingId,
                        companyId: currentUser.companyId
                    };
                    
                    localStorage.setItem('taskManagementEmployees', JSON.stringify(employees));
                    localStorage.setItem('taskManagementUsers', JSON.stringify(users));
                    
                    alert('Employee updated successfully!');
                }
            } else {
                // Add new employee
                const newId = 'emp' + Date.now().toString();
                const newEmployee = {
                    id: newId,
                    name,
                    email,
                    password,
                    position,
                    department,
                    companyId: currentUser.companyId
                };
                
                // Add to employees array
                employees.push(newEmployee);
                
                // Add to users object
                users[email] = { 
                    password, 
                    role: 'employee', 
                    name, 
                    id: newId,
                    companyId: currentUser.companyId
                };
                
                localStorage.setItem('taskManagementEmployees', JSON.stringify(employees));
                localStorage.setItem('taskManagementUsers', JSON.stringify(users));
                
                alert('Employee added successfully!');
            }
            
            // Reset form and hidden input
            document.getElementById('editingEmpId').value = '';
            document.getElementById('saveEmployeeBtn').textContent = 'Add Employee';
            e.target.reset();
            
            // Update UI
            updateEmployeeTable();
            populateEmployeeDropdowns();
            toggleAddEmployeeForm(false);
        }

        function handleNewDepartment(e) {
            e.preventDefault();
            const departmentName = document.getElementById('newDepartmentName').value.trim();
            
            if (!departmentName) {
                alert('Department name cannot be empty!');
                return;
            }
            
            // Check if department already exists for this company
            if (departments.some(dept => dept.name === departmentName && dept.companyId === currentUser.companyId)) {
                alert('This department already exists!');
                return;
            }
            
            // Add new department
            departments.push({
                name: departmentName,
                companyId: currentUser.companyId
            });
            
            // Sort alphabetically (within company)
            departments.sort((a, b) => {
                if (a.companyId !== b.companyId) return 0;
                return a.name.localeCompare(b.name);
            });
            
            // Save to localStorage
            localStorage.setItem('taskManagementDepartments', JSON.stringify(departments));
            
            // Update UI
            populateDepartmentDropdowns();
            updateDepartmentList();
            
            // Clear form
            document.getElementById('newDepartmentName').value = '';
            
            alert('Department added successfully!');
        }

        function deleteDepartment(departmentName) {
            // Check if department is being used by employees
            const empUsing = employees.filter(emp => 
                emp.department === departmentName && emp.companyId === currentUser.companyId
            );
            
            // Check if department is being used by tasks
            const tasksUsing = tasks.filter(task => 
                task.department === departmentName && task.companyId === currentUser.companyId
            );
            
            if (empUsing.length > 0 || tasksUsing.length > 0) {
                alert(`Cannot delete department "${departmentName}" as it is being used by ${empUsing.length} employee(s) and ${tasksUsing.length} task(s).`);
                return;
            }
            
            if (confirm(`Are you sure you want to delete the department "${departmentName}"?`)) {
                // Remove department
                departments = departments.filter(d => !(d.name === departmentName && d.companyId === currentUser.companyId));
                
                // Save to localStorage
                localStorage.setItem('taskManagementDepartments', JSON.stringify(departments));
                
                // Update UI
                populateDepartmentDropdowns();
                updateDepartmentList();
                
                alert('Department deleted successfully!');
            }
        }

        function showDepartmentModal() {
            updateDepartmentList();
            document.getElementById('departmentModal').classList.remove('hidden');
        }

        function closeDepartmentModal() {
            document.getElementById('departmentModal').classList.add('hidden');
        }

        function updateDepartmentList() {
            const departmentsList = document.getElementById('departmentsList');
            departmentsList.innerHTML = '';
            
            // Filter departments for the current company
            const companyDepartments = departments.filter(dept => dept.companyId === currentUser.companyId);
            
            companyDepartments.forEach(dept => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-2">${dept.name}</td>
                    <td class="p-2 text-right">
                        <button onclick="deleteDepartment('${dept.name}')" class="text-red-500 hover:text-red-700">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                departmentsList.appendChild(row);
            });
        }

        function populateDepartmentDropdowns() {
            if (!currentUser) return;
            
            // Filter departments for the current company
            const companyDepartments = departments.filter(dept => dept.companyId === currentUser.companyId);
            
            // Populate department selection in task form
            const departmentSelect = document.getElementById('department');
            if (departmentSelect) {
                departmentSelect.innerHTML = '<option value="">Select a department</option>';
                companyDepartments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.name;
                    option.textContent = dept.name;
                    departmentSelect.appendChild(option);
                });
            }
            
            // Populate employee form department select
            const empDepartmentSelect = document.getElementById('empDepartment');
            if (empDepartmentSelect) {
                empDepartmentSelect.innerHTML = '<option value="">Select a department</option>';
                companyDepartments.forEach(dept => {
                    const empOption = document.createElement('option');
                    empOption.value = dept.name;
                    empOption.textContent = dept.name;
                    empDepartmentSelect.appendChild(empOption);
                });
            }
            
            // Populate department filter
            const departmentFilter = document.getElementById('departmentFilter');
            if (departmentFilter) {
                departmentFilter.innerHTML = '<option value="all">All Departments</option>';
                companyDepartments.forEach(dept => {
                    const filterOption = document.createElement('option');
                    filterOption.value = dept.name;
                    filterOption.textContent = dept.name;
                    departmentFilter.appendChild(filterOption);
                });
            }
        }

        function populateEmployeeDropdowns() {
            if (!currentUser) return;
            
            // Filter employees for the current company
            const companyEmployees = employees.filter(emp => emp.companyId === currentUser.companyId);
            
            // Populate employee selection in task form
            const employeeSelect = document.getElementById('employeeSelect');
            if (employeeSelect) {
                employeeSelect.innerHTML = '<option value="">Select employee(s)</option>';
                companyEmployees.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = emp.name;
                    employeeSelect.appendChild(option);
                });
            }
            
            // Populate employee filter
            const employeeFilter = document.getElementById('employeeFilter');
            if (employeeFilter) {
                employeeFilter.innerHTML = '<option value="all">All Employees</option>';
                companyEmployees.forEach(emp => {
                    const filterOption = document.createElement('option');
                    filterOption.value = emp.id;
                    filterOption.textContent = emp.name;
                    employeeFilter.appendChild(filterOption);
                });
            }
        }

        function updateTaskList() {
            const taskList = document.getElementById('taskList');
            const statusFilter = document.getElementById('statusFilter').value;
            const employeeFilter = document.getElementById('employeeFilter').value;
            const departmentFilter = document.getElementById('departmentFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            
            // Filter tasks for the current company
            let filteredTasks = tasks.filter(task => task.companyId === currentUser.companyId);
            
            // Apply additional filters
            if (statusFilter !== 'all') {
                filteredTasks = filteredTasks.filter(task => task.status === statusFilter);
            }
            
            if (employeeFilter !== 'all') {
                filteredTasks = filteredTasks.filter(task => task.employees && task.employees.includes(employeeFilter));
            }
            
            if (departmentFilter !== 'all') {
                filteredTasks = filteredTasks.filter(task => task.department === departmentFilter);
            }
            
            if (priorityFilter !== 'all') {
                filteredTasks = filteredTasks.filter(task => task.priority === priorityFilter);
            }
            
            if (filteredTasks.length === 0) {
                taskList.innerHTML = '<p class="text-center text-gray-500 p-4">No tasks matching the selected filters</p>';
                return;
            }
            
            taskList.innerHTML = '';
            
            // Sort tasks by deadline (latest first)
            filteredTasks.sort((a, b) => new Date(b.deadline) - new Date(a.deadline));
            
            filteredTasks.forEach(task => {
                const assignedEmployees = task.employees 
                    ? task.employees.map(empId => employees.find(e => e.id === empId)?.name || 'Unknown').join(', ')
                    : 'Unknown';
                
                const deadlineDate = new Date(task.deadline);
                const isOverdue = deadlineDate < new Date() && task.status !== 'completed';
                
                const priorityColors = {
                    low: 'bg-green-100 text-green-800',
                    medium: 'bg-blue-100 text-blue-800',
                    high: 'bg-orange-100 text-orange-800',
                    urgent: 'bg-red-100 text-red-800'
                };
                
                const statusColors = {
                    'pending': 'bg-yellow-100 text-yellow-800',
                    'in-progress': 'bg-blue-100 text-blue-800',
                    'completed': 'bg-green-100 text-green-800',
                    'overdue': 'bg-red-100 text-red-800',
                    'revision-requested': 'bg-purple-100 text-purple-800'
                };

                // Check if there are unread comments
                const hasUnreadComments = task.comments && task.comments.some(comment => 
                    !comment.read && comment.authorEmail !== currentUser.email
                );
                
                const taskElement = document.createElement('div');
                taskElement.className = `task-card ${isOverdue ? 'border-red-500 border' : ''} bg-white p-4 rounded shadow`;
                taskElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h3 class="font-bold text-lg">
                            ${task.title}
                            ${hasUnreadComments ? '<span class="text-red-500 ml-2"><i class="bi bi-chat-dots-fill"></i></span>' : ''}
                        </h3>
                        <div class="flex flex-wrap gap-1">
                            <span class="px-2 py-1 rounded text-xs ${priorityColors[task.priority]}">${task.priority}</span>
                            <span class="px-2 py-1 rounded text-xs ${statusColors[isOverdue ? 'overdue' : task.status]}">
                                ${isOverdue ? 'Overdue' : task.status.replace('-', ' ')}
                            </span>
                        </div>
                    </div>
                    <p class="mt-2">${task.description}</p>
                    <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
                        <p class="text-gray-600"><i class="bi bi-people"></i> ${assignedEmployees}</p>
                        <p class="text-gray-600"><i class="bi bi-building"></i> ${task.department || 'Not specified'}</p>
                        <p class="text-gray-600"><i class="bi bi-clock"></i> ${task.hours} hours</p>
                        <p class="text-gray-600"><i class="bi bi-calendar"></i> ${new Date(task.deadline).toLocaleString()}</p>
                        <p class="text-gray-600"><i class="bi bi-arrow-repeat"></i> ${task.frequency}</p>
                    </div>
                    <div class="mt-3 flex justify-end space-x-2">
                        <button onclick="viewTaskDetails(${task.id}, true)" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">
                            <i class="bi bi-info-circle"></i> Details
                        </button>
                        <button onclick="editTask(${task.id})" class="text-blue-500 hover:text-blue-700">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button onclick="deleteTask(${task.id})" class="text-red-500 hover:text-red-700">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
                taskList.appendChild(taskElement);
            });
        }

        function updateEmployeeTable() {
            if (!currentUser) return;
            
            const tableBody = document.getElementById('employeeTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            // Filter employees for the current company
            const companyEmployees = employees.filter(emp => emp.companyId === currentUser.companyId);
            
            companyEmployees.forEach(emp => {
                // Calculate statistics
                const empTasks = tasks.filter(task => 
                    task.employees && 
                    task.employees.includes(emp.id) && 
                    task.companyId === currentUser.companyId
                );
                const completedTasks = empTasks.filter(task => task.status === 'completed');
                const completionRate = empTasks.length > 0 ? Math.round((completedTasks.length / empTasks.length) * 100) : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-2 px-4">${emp.name}</td>
                    <td class="py-2 px-4">${emp.email}</td>
                    <td class="py-2 px-4">${emp.position}</td>
                    <td class="py-2 px-4">${emp.department || 'Not assigned'}</td>
                    <td class="py-2 px-4">${empTasks.length} (${completedTasks.length} completed)</td>
                    <td class="py-2 px-4">
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-green-600 h-2.5 rounded-full" style="width: ${completionRate}%"></div>
                        </div>
                        <span class="text-sm">${completionRate}%</span>
                    </td>
                    <td class="py-2 px-4">
                        <button onclick="viewEmployeeTasks('${emp.id}')" class="text-blue-500 hover:text-blue-700 mr-2">
                            <i class="bi bi-list-check"></i>
                        </button>
                        <button onclick="editEmployee('${emp.id}')" class="text-blue-500 hover:text-blue-700 mr-2">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button onclick="deleteEmployee('${emp.id}')" class="text-red-500 hover:text-red-700">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function viewEmployeeTasks(empId) {
            // Filter tasks by employee and update status filter
            document.getElementById('employeeFilter').value = empId;
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('departmentFilter').value = 'all';
            document.getElementById('priorityFilter').value = 'all';
            
            // Switch to task management section
            showAdminSection('taskManagement');
            
            // Update task list with the filtered view
            updateTaskList();
        }

        function displayEmployeeTasks(statusFilter = 'all', priorityFilter = 'all') {
            if (!currentUser) return;
            
            const employeeTasks = document.getElementById('employeeTasks');
            const todaySchedule = document.getElementById('todaySchedule');
            if (!employeeTasks || !todaySchedule) return;
            
            employeeTasks.innerHTML = '';
            todaySchedule.innerHTML = '';
            
            // Get current employee ID
            const userID = currentUser.id;
            
            // Filter tasks for this employee and company
            let userTasks = tasks.filter(task => 
                task.employees && 
                task.employees.includes(userID) && 
                task.companyId === currentUser.companyId
            );
            
            // Apply status filter if specified
            if (statusFilter !== 'all') {
                userTasks = userTasks.filter(task => task.status === statusFilter);
            }
            
            // Apply priority filter if specified
            if (priorityFilter !== 'all') {
                userTasks = userTasks.filter(task => task.priority === priorityFilter);
            }
            
            // Update status filter button styling
            const filterButtons = document.querySelectorAll('[onclick^="filterEmployeeTasks(\'"]');
            filterButtons.forEach(button => {
                button.classList.remove('bg-blue-500', 'text-white');
                button.classList.add('bg-gray-200');
            });
            
            document.querySelector(`[onclick="filterEmployeeTasks('${statusFilter}')"]`).classList.remove('bg-gray-200');
            document.querySelector(`[onclick="filterEmployeeTasks('${statusFilter}')"]`).classList.add('bg-blue-500', 'text-white');
            
            // Update priority filter dropdown
            if (document.getElementById('empPriorityFilter')) {
                document.getElementById('empPriorityFilter').value = priorityFilter;
            }
            
            // Check if there are any tasks
            if (userTasks.length === 0) {
                employeeTasks.innerHTML = '<p class="text-gray-500 col-span-3 text-center p-4">No tasks matching the selected filters</p>';
            } else {
                // Sort tasks by deadline
                userTasks.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
                
                userTasks.forEach(task => {
                    const deadlineDate = new Date(task.deadline);
                    const isOverdue = deadlineDate < new Date() && task.status !== 'completed';
                    
                    const priorityColors = {
                        low: 'bg-green-100 text-green-800',
                        medium: 'bg-blue-100 text-blue-800',
                        high: 'bg-orange-100 text-orange-800',
                        urgent: 'bg-red-100 text-red-800'
                    };
                    
                    const statusColors = {
                        'pending': 'bg-yellow-100 text-yellow-800',
                        'in-progress': 'bg-blue-100 text-blue-800',
                        'completed': 'bg-green-100 text-green-800',
                        'overdue': 'bg-red-100 text-red-800',
                        'revision-requested': 'bg-purple-100 text-purple-800'
                    };

                    // Check if there are unread comments
                    const hasUnreadComments = task.comments && task.comments.some(comment => 
                        !comment.read && comment.authorEmail !== currentUser.email
                    );
                    
                    const taskElement = document.createElement('div');
                    taskElement.className = `task-card ${isOverdue ? 'border-red-500 border' : ''} bg-white p-4 rounded shadow`;
                    taskElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-lg">
                                ${task.title}
                                ${hasUnreadComments ? '<span class="text-red-500 ml-2"><i class="bi bi-chat-dots-fill"></i></span>' : ''}
                            </h3>
                            <div class="flex flex-wrap gap-1">
                                <span class="px-2 py-1 rounded text-xs ${priorityColors[task.priority]}">${task.priority}</span>
                                <span class="px-2 py-1 rounded text-xs ${statusColors[isOverdue ? 'overdue' : task.status]}">
                                    ${isOverdue ? 'Overdue' : task.status.replace('-', ' ')}
                                </span>
                            </div>
                        </div>
                        <p class="mt-2">${task.description}</p>
                        <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
                            <p class="text-gray-600"><i class="bi bi-building"></i> ${task.department || 'Not specified'}</p>
                            <p class="text-gray-600"><i class="bi bi-clock"></i> ${task.hours} hours</p>
                            <p class="text-gray-600"><i class="bi bi-calendar"></i> ${new Date(task.deadline).toLocaleString()}</p>
                            <p class="text-gray-600"><i class="bi bi-arrow-repeat"></i> ${task.frequency}</p>
                        </div>
                        <div class="mt-3 flex flex-wrap gap-2">
                            <button onclick="viewTaskDetails(${task.id}, false)" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">
                                <i class="bi bi-info-circle"></i> Details
                            </button>
                            ${task.status !== 'completed' ? `
                                ${task.status === 'pending' ? 
                                    `<button onclick="startTask(${task.id})" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">
                                        <i class="bi bi-play-fill"></i> Start
                                    </button>` : ''
                                }
                                ${task.status === 'in-progress' ? 
                                    `<button onclick="completeTask(${task.id})" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-sm">
                                        <i class="bi bi-check-lg"></i> Complete
                                    </button>` : ''
                                }
                                ${task.status !== 'revision-requested' ?
                                    `<button onclick="showRevisionForm(${task.id})" class="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600 text-sm">
                                        <i class="bi bi-clock-history"></i> Request Revision
                                    </button>` : ''
                                }
                                <select onchange="updateTaskStatus(${task.id}, this.value)" class="bg-gray-200 px-3 py-1 rounded text-sm">
                                    <option value="">Change Status</option>
                                    <option value="pending" ${task.status === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="in-progress" ${task.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                    <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>Completed</option>
                                </select>
                            ` : `
                                <span class="text-green-500"><i class="bi bi-check-circle"></i> Completed</span>
                                <button onclick="changeTaskStatus(${task.id}, 'pending')" class="bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 text-sm">
                                    <i class="bi bi-arrow-repeat"></i> Mark as Pending
                                </button>
                            `}
                        </div>
                    `;
                    employeeTasks.appendChild(taskElement);
                    
                    // Add to today's schedule if deadline is today
                    const today = new Date();
                    if (deadlineDate.toDateString() === today.toDateString()) {
                        const scheduleItem = document.createElement('div');
                        scheduleItem.className = `p-2 ${isOverdue ? 'bg-red-50' : 'bg-blue-50'} rounded mb-2`;
                        scheduleItem.innerHTML = `
                            <div class="flex justify-between items-center">
                                <span class="font-medium">${task.title}</span>
                                <span class="text-sm">${deadlineDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                            </div>
                            <p class="text-sm text-gray-600">${task.description.substring(0, 60)}${task.description.length > 60 ? '...' : ''}</p>
                            <div class="mt-1">
                                <button onclick="viewTaskDetails(${task.id}, false)" class="text-xs text-blue-500 hover:underline">View Details</button>
                            </div>
                        `;
                        todaySchedule.appendChild(scheduleItem);
                    }
                });
            }
            
            // If no tasks for today
            if (!todaySchedule.hasChildNodes()) {
                todaySchedule.innerHTML = '<p class="text-gray-500 text-center p-4">No tasks scheduled for today</p>';
            }
            
            // Update AI summary
            generateEmployeeAiSummary();
        }

        function filterEmployeeTasksByPriority() {
            const priorityFilter = document.getElementById('empPriorityFilter').value;
            const statusFilter = document.querySelector('[onclick^="filterEmployeeTasks"][class*="bg-blue-500"]')
                ? document.querySelector('[onclick^="filterEmployeeTasks"][class*="bg-blue-500"]').getAttribute('onclick').match(/'([^']+)'/)[1]
                : 'all';
            
            displayEmployeeTasks(statusFilter, priorityFilter);
        }

        function updateTaskStatus(taskId, newStatus) {
            if (!newStatus) return;
            changeTaskStatus(taskId, newStatus);
        }

        function changeTaskStatus(taskId, newStatus) {
            const task = tasks.find(t => t.id === taskId && t.companyId === currentUser.companyId);
            if (task) {
                // Store the previous status
                const previousStatus = task.status;
                
                // Update task status
                task.status = newStatus;
                
                if (newStatus === 'completed') {
                    task.completedAt = new Date().toISOString();
                } else if (previousStatus === 'completed') {
                    // If moving from completed to another status, remove completion date
                    delete task.completedAt;
                }
                
                // Save to localStorage
                localStorage.setItem('taskManagementTasks', JSON.stringify(tasks));
                
                // Refresh UI
                if (currentUser.role === 'admin') {
                    updateTaskList();
                    updateCalendar();
                    generateAiSummary();
                    updateEmployeeTable(); // Update completion rates in employee table
                } else {
                    const priorityFilter = document.getElementById('empPriorityFilter')
                        ? document.getElementById('empPriorityFilter').value
                        : 'all';
                    displayEmployeeTasks('all', priorityFilter);
                    updateEmployeePerformance();
                    updateEmployeeCalendar();
                    generateEmployeeAiSummary();
                }
                
                // Add notification
                let message = '';
                if (currentUser.role === 'admin') {
                    // Notify all task employees
                    if (task.employees) {
                        task.employees.forEach(empId => {
                            const employee = employees.find(e => e.id === empId && e.companyId === currentUser.companyId);
                            if (employee) {
                                message = `Admin changed your task "${task.title}" status to ${newStatus}`;
                                notifications.push({
                                    id: Date.now() + Math.random(),
                                    user: employee.email,
                                    message,
                                    timestamp: new Date().toISOString(),
                                    read: false,
                                    taskId: task.id,
                                    companyId: currentUser.companyId
                                });
                                updateEmployeeNotifications(employee.email);
                            }
                        });
                    }
                } else {
                    // Find the admin for this company
                    const adminEmails = Object.entries(users)
                        .filter(([_, user]) => user.role === 'admin' && user.companyId === currentUser.companyId)
                        .map(([email, _]) => email);
                    
                    adminEmails.forEach(adminEmail => {
                        message = `${currentUser.name} changed task "${task.title}" status to ${newStatus}`;
                        notifications.push({
                            id: Date.now() + Math.random(),
                            user: adminEmail,
                            message,
                            timestamp: new Date().toISOString(),
                            read: false,
                            taskId: task.id,
                            companyId: currentUser.companyId
                        });
                    });
                    
                    updateAdminNotifications();
                }
                
                localStorage.setItem('taskManagementNotifications', JSON.stringify(notifications));
                
                alert(`Task status updated to ${newStatus}`);
            }
        }

        function updateEmployeePerformance() {
            if (!currentUser) return;
            
            // Get current employee ID
            const userID = currentUser.id;
            
            // Filter tasks for this employee
            const userTasks = tasks.filter(task => 
                task.employees && 
                task.employees.includes(userID) && 
                task.companyId === currentUser.companyId
            );
            const completedTasks = userTasks.filter(task => task.status === 'completed');
            
            // Calculate performance metrics
            const completionRate = userTasks.length > 0 ? (completedTasks.length / userTasks.length) * 100 : 0;
            const totalHours = userTasks.reduce((sum, task) => sum + parseInt(task.hours), 0);
            const completedHours = completedTasks.reduce((sum, task) => sum + parseInt(task.hours), 0);
            
            // Update UI
            const completionRateEl = document.getElementById('completionRate');
            const completionRateTextEl = document.getElementById('completionRateText');
            const totalHoursEl = document.getElementById('totalHours');
            const completedHoursEl = document.getElementById('completedHours');
            
            if (completionRateEl && completionRateTextEl && totalHoursEl && completedHoursEl) {
                completionRateEl.style.width = `${completionRate}%`;
                completionRateTextEl.textContent = `${Math.round(completionRate)}%`;
                totalHoursEl.textContent = totalHours;
                completedHoursEl.textContent = completedHours;
            }
        }

        function startTask(taskId) {
            const task = tasks.find(t => t.id === taskId && t.companyId === currentUser.companyId);
            if (task) {
                task.status = 'in-progress';
                task.startedAt = new Date().toISOString();
                
                // Save to localStorage
                localStorage.setItem('taskManagementTasks', JSON.stringify(tasks));
                
                const priorityFilter = document.getElementById('empPriorityFilter')
                    ? document.getElementById('empPriorityFilter').value
                    : 'all';
                displayEmployeeTasks('all', priorityFilter);
                updateEmployeePerformance();
                updateEmployeeCalendar();
                
                // Add to notifications for admin
                // Find the admin for this company
                const adminEmails = Object.entries(users)
                    .filter(([_, user]) => user.role === 'admin' && user.companyId === currentUser.companyId)
                    .map(([email, _]) => email);
                
                adminEmails.forEach(adminEmail => {
                    notifications.push({
                        id: Date.now() + Math.random(),
                        user: adminEmail,
                        message: `${currentUser.name} started task: ${task.title}`,
                        timestamp: new Date().toISOString(),
                        read: false,
                        taskId: task.id,
                        companyId: currentUser.companyId
                    });
                });
                
                localStorage.setItem('taskManagementNotifications', JSON.stringify(notifications));
                updateAdminNotifications();
                
                alert('Task started successfully!');
            }
        }

        function completeTask(taskId) {
            const task = tasks.find(t => t.id === taskId && t.companyId === currentUser.companyId);
            if (task) {
                task.status = 'completed';
                task.completedAt = new Date().toISOString();
                
                // Save to localStorage
                localStorage.setItem('taskManagementTasks', JSON.stringify(tasks));
                
                const priorityFilter = document.getElementById('empPriorityFilter')
                    ? document.getElementById('empPriorityFilter').value
                    : 'all';
                displayEmployeeTasks('all', priorityFilter);
                updateEmployeePerformance();
                updateEmployeeCalendar();
                generateEmployeeAiSummary();
                
                // Add to notifications for admin
                // Find the admin for this company
                const adminEmails = Object.entries(users)
                    .filter(([_, user]) => user.role === 'admin' && user.companyId === currentUser.companyId)
                    .map(([email, _]) => email);
                
                adminEmails.forEach(adminEmail => {
                    notifications.push({
                        id: Date.now() + Math.random(),
                        user: adminEmail,
                        message: `${currentUser.name} completed task: ${task.title}`,
                        timestamp: new Date().toISOString(),
                        read: false,
                        taskId: task.id,
                        companyId: currentUser.companyId
                    });
                });
                
                localStorage.setItem('taskManagementNotifications', JSON.stringify(notifications));
                updateAdminNotifications();
                
                alert('Task completed successfully!');
            }
        }

        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId && t.companyId === currentUser.companyId);
            if (!task) return;
            
            // Set the editing task ID
            editingTaskId = taskId;
            
            // Clear the selected employees
            selectedEmployees = [];
            
            // Add all task employees to selected list
            if (task.employees && task.employees.length > 0) {
                task.employees.forEach(empId => {
                    const emp = employees.find(e => e.id === empId && e.companyId === currentUser.companyId);
                    if (emp) selectedEmployees.push(emp);
                });
            }
            
            // Update selected employees display
            updateSelectedEmployeesTags();
            document.getElementById('employeeIds').value = JSON.stringify(selectedEmployees.map(emp => emp.id));
            
            // Populate the form with task data
            document.getElementById('department').value = task.department || '';
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskDesc').value = task.description;
            document.getElementById('hours').value = task.hours;
            document.getElementById('deadline').value = task.deadline;
            document.getElementById('frequency').value = task.frequency;
            document.getElementById('priority').value = task.priority;
            document.getElementById('sendReminder').checked = task.sendReminder || false;
            
            // Scroll to the form
            document.getElementById('taskForm').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                const task = tasks.find(t => t.id === taskId && t.companyId === currentUser.companyId);
                if (!task) return;
                
                // Notify all employees assigned to the task
                if (task.employees) {
                    task.employees.forEach(empId => {
                        const assignedEmployee = employees.find(emp => emp.id === empId && emp.companyId === currentUser.companyId);
                        if (assignedEmployee) {
                            notifications.push({
                                id: Date.now() + Math.random(),
                                user: assignedEmployee.email,
                                message: `Task "${task.title}" has been deleted by admin`,
                                timestamp: new Date().toISOString(),
                                read: false,
                                companyId: currentUser.companyId
                            });
                            
                            updateEmployeeNotifications(assignedEmployee.email);
                        }
                    });
                }
                
                // Remove task
                tasks = tasks.filter(t => !(t.id === taskId && t.companyId === currentUser.companyId));
                localStorage.setItem('taskManagementTasks', JSON.stringify(tasks));
                localStorage.setItem('taskManagementNotifications', JSON.stringify(notifications));
                
                updateTaskList();
                updateCalendar();
                generateAiSummary();
                // Also update employee table to reflect task changes
                updateEmployeeTable();
                
                alert('Task deleted successfully');
            }
        }

        function editEmployee(empId) {
            const employee = employees.find(emp => emp.id === empId && emp.companyId === currentUser.companyId);
            if (!employee) return;
            
            toggleAddEmployeeForm(true);
            
            // Set editing employee ID
            document.getElementById('editingEmpId').value = empId;
            
            // Populate the form with employee data
            document.getElementById('empName').value = employee.name;
            document.getElementById('empEmail').value = employee.email;
            document.getElementById('empPassword').value = employee.password;
            document.getElementById('empPosition').value = employee.position;
            document.getElementById('empDepartment').value = employee.department || '';
            
            // Change submit button text
            document.getElementById('saveEmployeeBtn').textContent = "Update Employee";
        }

        function deleteEmployee(empId) {
            if (confirm('Are you sure you want to delete this employee?')) {
                const employeeToRemove = employees.find(emp => emp.id === empId && emp.companyId === currentUser.companyId);
                
                if (employeeToRemove) {
                    // Check if employee has tasks
                    const empTasks = tasks.filter(task => 
                        task.employees && 
                        task.employees.includes(empId) && 
                        task.companyId === currentUser.companyId
                    );
                    
                    if (empTasks.length > 0) {
                        if (confirm(`This employee has ${empTasks.length} assigned tasks. Delete the employee and remove them from all tasks?`)) {
                            // Update tasks to remove this employee
                            tasks = tasks.map(task => {
                                if (task.employees && task.employees.includes(empId) && task.companyId === currentUser.companyId) {
                                    // Remove employee from task
                                    return {
                                        ...task,
                                        employees: task.employees.filter(id => id !== empId)
                                    };
                                }
                                return task;
                            });
                            
                            // Delete any tasks that now have no employees
                            tasks = tasks.filter(task => 
                                !(task.companyId === currentUser.companyId && 
                                  (!task.employees || task.employees.length === 0))
                            );
                            
                            localStorage.setItem('taskManagementTasks', JSON.stringify(tasks));
                            
                            // Remove employee from employees array
                            employees = employees.filter(emp => !(emp.id === empId && emp.companyId === currentUser.companyId));
                            
                            // Remove from users object
                            delete users[employeeToRemove.email];
                            
                            localStorage.setItem('taskManagementEmployees', JSON.stringify(employees));
                            localStorage.setItem('taskManagementUsers', JSON.stringify(users));
                            
                            alert('Employee deleted and removed from tasks successfully.');
                        } else {
                            return; // Cancel deletion
                        }
                    } else {
                        // No tasks, just remove the employee
                        employees = employees.filter(emp => !(emp.id === empId && emp.companyId === currentUser.companyId));
                        
                        // Remove from users object
                        delete users[employeeToRemove.email];
                        
                        localStorage.setItem('taskManagementEmployees', JSON.stringify(employees));
                        localStorage.setItem('taskManagementUsers', JSON.stringify(users));
                        
                        alert('Employee deleted successfully.');
                    }
                    
                    // Update UI
                    updateEmployeeTable();
                    populateEmployeeDropdowns();
                    updateTaskList();
                    updateCalendar();
                }
            }
        }

        function toggleAddEmployeeForm(show) {
            const form = document.getElementById('addEmployeeForm');
            if (!form) return;
            
            if (show === true) {
                form.classList.remove('hidden');
            } else if (show === false) {
                form.classList.add('hidden');
                // Reset form when hiding
                document.getElementById('newEmployeeForm').reset();
                document.getElementById('editingEmpId').value = '';
                // Reset button text
                document.getElementById('saveEmployeeBtn').textContent = "Add Employee";
            } else {
                form.classList.toggle('hidden');
                if (form.classList.contains('hidden')) {
                    // Reset form when toggling to hidden
                    document.getElementById('newEmployeeForm').reset();
                    document.getElementById('editingEmpId').value = '';
                    // Reset button text
                    document.getElementById('saveEmployeeBtn').textContent = "Add Employee";
                }
            }
        }

        function showAdminSection(sectionId) {
            // Hide all sections
            document.getElementById('taskManagementSection').classList.add('hidden');
            document.getElementById('employeeListSection').classList.add('hidden');
            document.getElementById('analyticsSection').classList.add('hidden');
            document.getElementById('emailScraperSection').classList.add('hidden');
            document.getElementById('calendarSection').classList.add('hidden');
            
            // Show the selected section
            document.getElementById(sectionId + 'Section').classList.remove('hidden');
            
            // Update UI for the active section
            if (sectionId === 'taskManagement') {
                updateTaskList();
                generateAiSummary();
            } else if (sectionId === 'employeeList') {
                updateEmployeeTable();
            } else if (sectionId === 'analytics') {
                updateAnalytics();
            } else if (sectionId === 'calendar') {
                updateCalendar();
            }
        }

        function showEmployeeSection(sectionId) {
            // Hide all sections
            document.getElementById('employeeTasksSection').classList.add('hidden');
            document.getElementById('employeeCalendarSection').classList.add('hidden');
            
            // Show the selected section
            document.getElementById('employee' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1) + 'Section').classList.remove('hidden');
            
            // Update UI for the active section
            if (sectionId === 'tasks') {
                displayEmployeeTasks('all');
                updateEmployeePerformance();
                generateEmployeeAiSummary();
            } else if (sectionId === 'calendar') {
                updateEmployeeCalendar();
            }
        }

        function updateAnalytics() {
            // Update completion rate chart
            updateCompletionRateChart();
            
            // Update hours allocation chart
            updateHoursAllocationChart();
            
            // Update department chart
            updateDepartmentChart();
            
            // Update priority chart
            updatePriorityChart();
            
            // Update performance summary table
            updatePerformanceSummary();
        }

        function updateCalendar() {
            if (!currentUser) return;
            
            const calendarBody = document.getElementById('calendarBody');
            const monthYearDisplay = document.getElementById('currentMonthYear');
            
            if (!calendarBody || !monthYearDisplay) return;
            
            // Set the month and year display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            monthYearDisplay.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            // Get first day of the month
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            
            // Get last day of the month
            const lastDay = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            // Clear previous calendar
            calendarBody.innerHTML = '';
            
            // Create calendar rows
            let dayCounter = 1;
            let calendarHtml = '';
            
            // Create weeks until we've used all days
            while (dayCounter <= lastDay) {
                calendarHtml += '<tr>';
                
                // Create days in each week
                for (let i = 0; i < 7; i++) {
                    if ((dayCounter === 1 && i < firstDay) || dayCounter > lastDay) {
                        // Empty cell
                        calendarHtml += '<td class="bg-gray-50"></td>';
                    } else {
                        // Date cell with tasks
                        const currentDate = new Date(currentYear, currentMonth, dayCounter);
                        const dateString = currentDate.toISOString().split('T')[0];
                        
                        // Find tasks due on this date
                        const dayTasks = tasks.filter(task => {
                            const taskDate = new Date(task.deadline);
                            return task.companyId === currentUser.companyId &&
                                taskDate.getFullYear() === currentYear && 
                                taskDate.getMonth() === currentMonth && 
                                taskDate.getDate() === dayCounter;
                        });
                        
                        // Create cell with date and tasks
                        calendarHtml += `
                            <td class="border text-sm bg-white cursor-pointer" onclick="showDayTasks(${currentYear}, ${currentMonth}, ${dayCounter}, true)">
                                <span class="date">${dayCounter}</span>
                                <div class="tasks">
                                    ${dayTasks.slice(0, 3).map(task => {
                                        const priorityClass = task.priority === 'high' || task.priority === 'urgent' ? 
                                            `task-item ${task.priority}` : 'task-item';
                                        
                                        return `<div class="${priorityClass}" title="${task.title}" onclick="event.stopPropagation(); viewTaskDetails(${task.id}, true)">
                                            ${task.title.length > 15 ? task.title.substring(0, 15) + '...' : task.title}
                                        </div>`;
                                    }).join('')}
                                    ${dayTasks.length > 3 ? `<div class="text-xs text-gray-500 mt-1">+${dayTasks.length - 3} more</div>` : ''}
                                </div>
                            </td>
                        `;
                        
                        dayCounter++;
                    }
                }
                
                calendarHtml += '</tr>';
            }
            
            calendarBody.innerHTML = calendarHtml;
        }

        function updateEmployeeCalendar() {
            if (!currentUser) return;
            
            const calendarBody = document.getElementById('employeeCalendarBody');
            const monthYearDisplay = document.getElementById('employeeCurrentMonthYear');
            
            if (!calendarBody || !monthYearDisplay) return;
            
            // Set the month and year display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            monthYearDisplay.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            // Get first day of the month
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            
            // Get last day of the month
            const lastDay = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            // Clear previous calendar
            calendarBody.innerHTML = '';
            
            // Create calendar rows
            let dayCounter = 1;
            let calendarHtml = '';
            
            // Create weeks until we've used all days
            while (dayCounter <= lastDay) {
                calendarHtml += '<tr>';
                
                // Create days in each week
                for (let i = 0; i < 7; i++) {
                    if ((dayCounter === 1 && i < firstDay) || dayCounter > lastDay) {
                        // Empty cell
                        calendarHtml += '<td class="bg-gray-50"></td>';
                    } else {
                        // Date cell with tasks
                        const currentDate = new Date(currentYear, currentMonth, dayCounter);
                        const dateString = currentDate.toISOString().split('T')[0];
                        
                        // Find employee's tasks due on this date
                        const dayTasks = tasks.filter(task => {
                            const taskDate = new Date(task.deadline);
                            return task.companyId === currentUser.companyId &&
                                task.employees && task.employees.includes(currentUser.id) &&
                                taskDate.getFullYear() === currentYear && 
                                taskDate.getMonth() === currentMonth && 
                                taskDate.getDate() === dayCounter;
                        });
                        
                        // Create cell with date and tasks
                        calendarHtml += `
                            <td class="border text-sm bg-white cursor-pointer" onclick="showDayTasks(${currentYear}, ${currentMonth}, ${dayCounter}, false)">
                                <span class="date">${dayCounter}</span>
                                <div class="tasks">
                                    ${dayTasks.slice(0, 3).map(task => {
                                        const priorityClass = task.priority === 'high' || task.priority === 'urgent' ? 
                                            `task-item ${task.priority}` : 'task-item';
                                        
                                        return `<div class="${priorityClass}" title="${task.title}" onclick="event.stopPropagation(); viewTaskDetails(${task.id}, false)">
                                            ${task.title.length > 15 ? task.title.substring(0, 15) + '...' : task.title}
                                        </div>`;
                                    }).join('')}
                                    ${dayTasks.length > 3 ? `<div class="text-xs text-gray-500 mt-1">+${dayTasks.length - 3} more</div>` : ''}
                                </div>
                            </td>
                        `;
                        
                        dayCounter++;
                    }
                }
                
                calendarHtml += '</tr>';
            }
            
            calendarBody.innerHTML = calendarHtml;
        }

        function showDayTasks(year, month, day, isAdmin) {
            const date = new Date(year, month, day);
            const dateString = date.toLocaleDateString(undefined, { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            document.getElementById('calendarTaskDate').textContent = `Tasks for ${dateString}`;
            
            const tasksListContainer = document.getElementById('calendarTasksList');
            tasksListContainer.innerHTML = '';
            
            // Find tasks for this day
            let dayTasks;
            
            if (isAdmin) {
                // Admin sees all tasks for their company
                dayTasks = tasks.filter(task => {
                    const taskDate = new Date(task.deadline);
                    return task.companyId === currentUser.companyId &&
                        taskDate.getFullYear() === year && 
                        taskDate.getMonth() === month && 
                        taskDate.getDate() === day;
                });
            } else {
                // Employee sees only their tasks
                dayTasks = tasks.filter(task => {
                    const taskDate = new Date(task.deadline);
                    return task.companyId === currentUser.companyId &&
                        task.employees && task.employees.includes(currentUser.id) &&
                        taskDate.getFullYear() === year && 
                        taskDate.getMonth() === month && 
                        taskDate.getDate() === day;
                });
            }
            
            // Sort tasks by priority (urgent first)
            dayTasks.sort((a, b) => {
                const priorityOrder = { urgent: 1, high: 2, medium: 3, low: 4 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });
            
            // Display tasks or no tasks message
            if (dayTasks.length === 0) {
                tasksListContainer.innerHTML = '<p class="text-gray-500 text-center p-4">No tasks due on this day</p>';
            } else {
                dayTasks.forEach(task => {
                    const priorityColors = {
                        low: 'bg-green-100 text-green-800',
                        medium: 'bg-blue-100 text-blue-800',
                        high: 'bg-orange-100 text-orange-800',
                        urgent: 'bg-red-100 text-red-800'
                    };
                    
                    const statusColors = {
                        'pending': 'bg-yellow-100 text-yellow-800',
                        'in-progress': 'bg-blue-100 text-blue-800',
                        'completed': 'bg-green-100 text-green-800',
                        'revision-requested': 'bg-purple-100 text-purple-800'
                    };
                    
                    const deadlineTime = new Date(task.deadline).toLocaleTimeString([], {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const assignedEmployees = isAdmin && task.employees
                        ? task.employees.map(empId => {
                            const emp = employees.find(e => e.id === empId && e.companyId === currentUser.companyId);
                            return emp ? emp.name : 'Unknown';
                          }).join(', ')
                        : '';
                    
                    const taskItem = document.createElement('div');
                    taskItem.className = 'mb-4 p-3 bg-white border rounded shadow-sm';
                    taskItem.innerHTML = `
                        <div class="flex justify-between items-start">
                            <h3 class="font-semibold">${task.title}</h3>
                            <div class="flex space-x-1">
                                <span class="px-2 py-1 rounded text-xs ${priorityColors[task.priority]}">${task.priority}</span>
                                <span class="px-2 py-1 rounded text-xs ${statusColors[task.status]}">${task.status.replace('-', ' ')}</span>
                            </div>
                        </div>
                        <p class="mt-1 text-sm text-gray-700">${task.description}</p>
                        <div class="mt-2 text-sm text-gray-600">
                            <p><span class="font-medium">Due:</span> ${deadlineTime}</p>
                            ${isAdmin ? `<p><span class="font-medium">Assigned to:</span> ${assignedEmployees}</p>` : ''}
                            <p><span class="font-medium">Department:</span> ${task.department || 'Not specified'}</p>
                        </div>
                        <div class="mt-3 flex space-x-2">
                            <button onclick="viewTaskDetails(${task.id}, ${isAdmin})" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">
                                <i class="bi bi-info-circle"></i> View Details
                            </button>
                            ${isAdmin ? `
                                <button onclick="editTask(${task.id})" class="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600 text-sm">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                            ` : ''}
                        </div>
                    `;
                    tasksListContainer.appendChild(taskItem);
                });
            }
            
            // Show the modal
            document.getElementById('calendarTaskModal').classList.remove('hidden');
        }

        function closeCalendarTaskModal() {
            document.getElementById('calendarTaskModal').classList.add('hidden');
        }

        function changeMonth(delta) {
            currentMonth += delta;
            
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            
            updateCalendar();
        }

        function changeEmployeeMonth(delta) {
            currentMonth += delta;
            
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            
            updateEmployeeCalendar();
        }

        function generateAiSummary() {
            if (!currentUser) return;
            
            const aiSummary = document.getElementById('aiSummary');
            if (!aiSummary) return;
            
            // Filter tasks for this company
            const companyTasks = tasks.filter(task => task.companyId === currentUser.companyId);
            
            // Count total and pending tasks
            const totalTasks = companyTasks.length;
            const pendingTasks = companyTasks.filter(task => task.status === 'pending').length;
            const inProgressTasks = companyTasks.filter(task => task.status === 'in-progress').length;
            const completedTasks = companyTasks.filter(task => task.status === 'completed').length;
            const overdueTasks = companyTasks.filter(task => {
                const deadlineDate = new Date(task.deadline);
                return deadlineDate < new Date() && task.status !== 'completed';
            }).length;
            const revisionRequestedTasks = companyTasks.filter(task => task.status === 'revision-requested').length;
            
            // Urgent tasks due soon
            const today = new Date();
            const upcoming = new Date();
            upcoming.setDate(today.getDate() + 7);
            
            const urgentUpcoming = companyTasks.filter(task => {
                if (task.status === 'completed') return false;
                
                const deadlineDate = new Date(task.deadline);
                return (task.priority === 'high' || task.priority === 'urgent') && 
                       deadlineDate >= today && deadlineDate <= upcoming;
            });
            
            // Department with most pending tasks
            const deptPendingCounts = {};
            companyTasks.filter(task => task.status === 'pending' || task.status === 'in-progress')
                 .forEach(task => {
                     if (task.department) {
                         deptPendingCounts[task.department] = (deptPendingCounts[task.department] || 0) + 1;
                     }
                 });
            
            let busyDept = 'None';
            let maxPending = 0;
            
            for (const [dept, count] of Object.entries(deptPendingCounts)) {
                if (count > maxPending) {
                    maxPending = count;
                    busyDept = dept;
                }
            }
            
            // Employees with high workload
            const employeeTaskCounts = {};
            companyTasks.filter(task => task.status === 'pending' || task.status === 'in-progress')
                 .forEach(task => {
                     if (task.employees) {
                         task.employees.forEach(empId => {
                             employeeTaskCounts[empId] = (employeeTaskCounts[empId] || 0) + 1;
                         });
                     }
                 });
            
            const busyEmployees = [];
            for (const [empId, count] of Object.entries(employeeTaskCounts)) {
                if (count >= 3) {
                    const emp = employees.find(e => e.id === empId && e.companyId === currentUser.companyId);
                    if (emp) {
                        busyEmployees.push({ name: emp.name, tasks: count });
                    }
                }
            }
            
            // Generate summary HTML
            aiSummary.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="p-3 bg-blue-100 rounded">
                        <h3 class="font-semibold mb-1">Task Status</h3>
                        <p><span class="font-medium">Total:</span> ${totalTasks} tasks</p>
                        <p><span class="font-medium">Pending:</span> ${pendingTasks} tasks</p>
                        <p><span class="font-medium">In Progress:</span> ${inProgressTasks} tasks</p>
                        <p><span class="font-medium">Completed:</span> ${completedTasks} tasks</p>
                        <p><span class="font-medium text-red-500">Overdue:</span> ${overdueTasks} tasks</p>
                        <p><span class="font-medium text-purple-500">Revision Requested:</span> ${revisionRequestedTasks} tasks</p>
                    </div>
                    
                    <div class="p-3 ${urgentUpcoming.length > 0 ? 'bg-red-50' : 'bg-green-50'} rounded">
                        <h3 class="font-semibold mb-1">Urgent Tasks Due Soon</h3>
                        ${urgentUpcoming.length > 0 ? 
                            `<p>You have <span class="font-medium text-red-500">${urgentUpcoming.length}</span> high priority tasks due in the next 7 days:</p>
                             <ul class="list-disc ml-5 mt-1">
                                ${urgentUpcoming.slice(0, 3).map(task => `
                                    <li>${task.title} - Due: ${new Date(task.deadline).toLocaleDateString()}</li>
                                `).join('')}
                                ${urgentUpcoming.length > 3 ? `<li>And ${urgentUpcoming.length - 3} more...</li>` : ''}
                             </ul>` : 
                            `<p class="text-green-600">No urgent tasks due in the next week. Good job!</p>`
                        }
                    </div>
                    
                    <div class="p-3 bg-yellow-50 rounded">
                        <h3 class="font-semibold mb-1">Department Workload</h3>
                        <p>The department with the most pending tasks is: <span class="font-medium">${busyDept}</span> with ${maxPending} tasks.</p>
                        
                        <h3 class="font-semibold mt-3 mb-1">Employee Workload</h3>
                        ${busyEmployees.length > 0 ? `
                            <p>Employees with high workload:</p>
                            <ul class="list-disc ml-5 mt-1">
                                ${busyEmployees.slice(0, 3).map(emp => `
                                    <li>${emp.name} - ${emp.tasks} tasks</li>
                                `).join('')}
                            </ul>
                        ` : '<p>No employees have a high workload at the moment.</p>'}
                    </div>
                </div>
                
                <p class="text-sm text-gray-600">
                    <i class="bi bi-lightning"></i> <strong>AI Recommendation:</strong>
                    ${overdueTasks > 0 ? 
                        `Focus on addressing the ${overdueTasks} overdue tasks first. Consider redistributing work if certain employees or departments are overwhelmed.` :
                        `All tasks are on track! Focus on maintaining momentum and planning ahead for upcoming work.`
                    }
                    ${revisionRequestedTasks > 0 ? ` Review the ${revisionRequestedTasks} task(s) with revision requests promptly.` : ''}
                </p>
            `;
        }

        function generateEmployeeAiSummary() {
            if (!currentUser) return;
            
            const aiSummary = document.getElementById('employeeAiSummary');
            if (!aiSummary) return;
            
            // Get current employee ID
            const userID = currentUser.id;
            
            // Filter tasks for this employee and company
            const userTasks = tasks.filter(task => 
                task.employees && 
                task.employees.includes(userID) && 
                task.companyId === currentUser.companyId
            );
            const pendingTasks = userTasks.filter(task => task.status === 'pending');
            const inProgressTasks = userTasks.filter(task => task.status === 'in-progress');
            const completedTasks = userTasks.filter(task => task.status === 'completed');
            
            const overdueTasks = userTasks.filter(task => {
                const deadlineDate = new Date(task.deadline);
                return deadlineDate < new Date() && task.status !== 'completed';
            });
            
            // Upcoming deadlines
            const today = new Date();
            const threeDaysLater = new Date();
            threeDaysLater.setDate(today.getDate() + 3);
            
            const upcomingTasks = userTasks.filter(task => {
                if (task.status === 'completed') return false;
                
                const deadlineDate = new Date(task.deadline);
                return deadlineDate >= today && deadlineDate <= threeDaysLater;
            });
            
            // Calculate completion rate
            const completionRate = userTasks.length > 0 ? (completedTasks.length / userTasks.length) * 100 : 0;
            
            // Generate summary HTML
            aiSummary.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="p-3 bg-blue-100 rounded">
                        <h3 class="font-semibold mb-1">Your Task Status</h3>
                        <p><span class="font-medium">Total Tasks:</span> ${userTasks.length}</p>
                        <p><span class="font-medium">Pending:</span> ${pendingTasks.length}</p>
                        <p><span class="font-medium">In Progress:</span> ${inProgressTasks.length}</p>
                        <p><span class="font-medium">Completed:</span> ${completedTasks.length} (${Math.round(completionRate)}%)</p>
                        <p><span class="font-medium text-red-500">Overdue:</span> ${overdueTasks.length}</p>
                    </div>
                    
                    <div class="p-3 ${upcomingTasks.length > 0 ? 'bg-yellow-50' : 'bg-green-50'} rounded">
                        <h3 class="font-semibold mb-1">Upcoming Deadlines</h3>
                        ${upcomingTasks.length > 0 ? 
                            `<p>You have <span class="font-medium">${upcomingTasks.length}</span> tasks due in the next 3 days:</p>
                             <ul class="list-disc ml-5 mt-1">
                                ${upcomingTasks.map(task => `
                                    <li class="${task.priority === 'high' || task.priority === 'urgent' ? 'text-red-600' : ''}">
                                        ${task.title} - Due: ${new Date(task.deadline).toLocaleString()}
                                        ${task.priority === 'high' || task.priority === 'urgent' ? ' (Priority!)' : ''}
                                    </li>
                                `).join('')}
                             </ul>` : 
                            `<p class="text-green-600">No tasks due in the next three days.</p>`
                        }
                    </div>
                </div>
                
                <p class="text-sm text-gray-600">
                    <i class="bi bi-lightning"></i> <strong>AI Recommendation:</strong>
                    ${overdueTasks.length > 0 ? 
                        `Focus on addressing your ${overdueTasks.length} overdue task(s) first. Consider requesting timeline revisions if needed.` :
                        upcomingTasks.length > 0 ?
                        `Prioritize your ${upcomingTasks.length} upcoming deadline(s) in the next few days.` :
                        `You're on track with your tasks! Consider starting on new pending tasks to maintain momentum.`
                    }
                    ${pendingTasks.length > 3 ? ` You have ${pendingTasks.length} pending tasks - consider starting on them soon.` : ''}
                </p>
            `;
        }

        function emailDailySummary() {
            // In a real implementation, this would send an email with the summary
            if (currentUser.role === 'admin') {
                alert('In a real implementation, this would email the AI summary to all employees and admin of your company.');
            } else {
                alert('In a real implementation, this would email your personal task summary to you.');
            }
        }

        function updateCompletionRateChart() {
            if (!currentUser) return;
            
            const chartContainer = document.getElementById('completionRateChart');
            if (!chartContainer) return;
            
            chartContainer.innerHTML = '';
            
            // Filter employees for the current company
            const companyEmployees = employees.filter(emp => emp.companyId === currentUser.companyId);
            
            // Calculate completion rates for each employee
            const employeeStats = companyEmployees.map(emp => {
                const empTasks = tasks.filter(task => 
                    task.companyId === currentUser.companyId &&
                    task.employees && 
                    task.employees.includes(emp.id)
                );
                const completedTasks = empTasks.filter(task => task.status === 'completed');
                const completionRate = empTasks.length > 0 ? (completedTasks.length / empTasks.length) * 100 : 0;
                
                return {
                    name: emp.name,
                    completionRate: Math.round(completionRate)
                };
            });
            
            // Sort by completion rate
            employeeStats.sort((a, b) => b.completionRate - a.completionRate);
            
            // Create X and Y axes
            const xAxis = document.createElement('div');
            xAxis.className = 'absolute left-0 bottom-0 w-full border-t border-gray-300';
            chartContainer.appendChild(xAxis);
            
            const yAxis = document.createElement('div');
            yAxis.className = 'absolute left-0 top-0 h-full border-r border-gray-300';
            chartContainer.appendChild(yAxis);
            
            // Add Y-axis labels
            for (let i = 0; i <= 100; i += 20) {
                const label = document.createElement('div');
                label.className = 'absolute text-xs text-gray-600';
                label.style.left = '-25px';
                label.style.bottom = `${i * 2.5}px`;
                label.textContent = `${i}%`;
                yAxis.appendChild(label);
            }
            
            // Create bars for each employee
            employeeStats.forEach((stat, index) => {
                const barContainer = document.createElement('div');
                barContainer.className = 'relative';
                barContainer.style.left = `${50 + index * 70}px`;
                
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = `${stat.completionRate * 2.5}px`;
                
                const valueLabel = document.createElement('div');
                valueLabel.className = 'value-label';
                valueLabel.textContent = `${stat.completionRate}%`;
                
                const nameLabel = document.createElement('div');
                nameLabel.className = 'bar-label';
                nameLabel.textContent = stat.name.split(' ')[0];
                
                barContainer.appendChild(bar);
                barContainer.appendChild(valueLabel);
                barContainer.appendChild(nameLabel);
                
                chartContainer.appendChild(barContainer);
            });
        }

        function updateHoursAllocationChart() {
            if (!currentUser) return;
            
            const chartContainer = document.getElementById('hoursChart');
            if (!chartContainer) return;
            
            chartContainer.innerHTML = '';
            
            // Filter employees for the current company
            const companyEmployees = employees.filter(emp => emp.companyId === currentUser.companyId);
            
            // Calculate hours for each employee
            const employeeStats = companyEmployees.map(emp => {
                const empTasks = tasks.filter(task => 
                    task.companyId === currentUser.companyId &&
                    task.employees && 
                    task.employees.includes(emp.id)
                );
                const totalHours = empTasks.reduce((sum, task) => sum + parseInt(task.hours), 0);
                const completedTasks = empTasks.filter(task => task.status === 'completed');
                const completedHours = completedTasks.reduce((sum, task) => sum + parseInt(task.hours), 0);
                
                return {
                    name: emp.name,
                    totalHours,
                    completedHours
                };
            });
            
            // Sort by total hours
            employeeStats.sort((a, b) => b.totalHours - a.totalHours);
            
            // Find max hours for scale
            const maxHours = Math.max(...employeeStats.map(stat => stat.totalHours), 10);
            const scale = 250 / maxHours;
            
            // Create X and Y axes
            const xAxis = document.createElement('div');
            xAxis.className = 'absolute left-0 bottom-0 w-full border-t border-gray-300';
            chartContainer.appendChild(xAxis);
            
            const yAxis = document.createElement('div');
            yAxis.className = 'absolute left-0 top-0 h-full border-r border-gray-300';
            chartContainer.appendChild(yAxis);
            
            // Add Y-axis labels
            for (let i = 0; i <= maxHours; i += Math.ceil(maxHours / 5)) {
                const label = document.createElement('div');
                label.className = 'absolute text-xs text-gray-600';
                label.style.left = '-25px';
                label.style.bottom = `${i * scale}px`;
                label.textContent = `${i}h`;
                yAxis.appendChild(label);
            }
            
            // Create bars for each employee
            employeeStats.forEach((stat, index) => {
                // Total hours bar
                const totalBarContainer = document.createElement('div');
                totalBarContainer.className = 'relative';
                totalBarContainer.style.left = `${50 + index * 100}px`;
                
                const totalBar = document.createElement('div');
                totalBar.className = 'bar';
                totalBar.style.height = `${stat.totalHours * scale}px`;
                totalBar.style.backgroundColor = '#93c5fd';
                
                const totalValueLabel = document.createElement('div');
                totalValueLabel.className = 'value-label';
                totalValueLabel.textContent = `${stat.totalHours}h`;
                
                const totalNameLabel = document.createElement('div');
                totalNameLabel.className = 'bar-label';
                totalNameLabel.textContent = `${stat.name.split(' ')[0]} (Total)`;
                
                totalBarContainer.appendChild(totalBar);
                totalBarContainer.appendChild(totalValueLabel);
                totalBarContainer.appendChild(totalNameLabel);
                
                chartContainer.appendChild(totalBarContainer);
                
                // Completed hours bar
                const completedBarContainer = document.createElement('div');
                completedBarContainer.className = 'relative';
                completedBarContainer.style.left = `${90 + index * 100}px`;
                
                const completedBar = document.createElement('div');
                completedBar.className = 'bar';
                completedBar.style.height = `${stat.completedHours * scale}px`;
                completedBar.style.backgroundColor = '#4ade80';
                
                const completedValueLabel = document.createElement('div');
                completedValueLabel.className = 'value-label';
                completedValueLabel.textContent = `${stat.completedHours}h`;
                
                const completedNameLabel = document.createElement('div');
                completedNameLabel.className = 'bar-label';
                completedNameLabel.textContent = `(Completed)`;
                
                completedBarContainer.appendChild(completedBar);
                completedBarContainer.appendChild(completedValueLabel);
                completedBarContainer.appendChild(completedNameLabel);
                
                chartContainer.appendChild(completedBarContainer);
            });
        }

        function updateDepartmentChart() {
            if (!currentUser) return;
            
            const chartContainer = document.getElementById('departmentChart');
            if (!chartContainer) return;
            
            chartContainer.innerHTML = '';
            
            // Filter departments for the current company
            const companyDepartments = departments
                .filter(dept => dept.companyId === currentUser.companyId)
                .map(dept => dept.name);
            
            // Calculate stats for each department
            const departmentStats = [];
            companyDepartments.forEach(dept => {
                const deptTasks = tasks.filter(task => 
                    task.department === dept && 
                    task.companyId === currentUser.companyId
                );
                const completedTasks = deptTasks.filter(task => task.status === 'completed');
                const pendingTasks = deptTasks.filter(task => task.status === 'pending');
                const inProgressTasks = deptTasks.filter(task => task.status === 'in-progress');
                
                if (deptTasks.length > 0) {
                    departmentStats.push({
                        name: dept,
                        total: deptTasks.length,
                        completed: completedTasks.length,
                        pending: pendingTasks.length,
                        inProgress: inProgressTasks.length,
                        completionRate: Math.round((completedTasks.length / deptTasks.length) * 100)
                    });
                }
            });
            
            // Sort by total tasks
            departmentStats.sort((a, b) => b.total - a.total);
            
            // Find max tasks for scale
            const maxTasks = Math.max(...departmentStats.map(stat => stat.total), 5);
            const scale = 250 / maxTasks;
            
            // Create X and Y axes
            const xAxis = document.createElement('div');
            xAxis.className = 'absolute left-0 bottom-0 w-full border-t border-gray-300';
            chartContainer.appendChild(xAxis);
            
            const yAxis = document.createElement('div');
            yAxis.className = 'absolute left-0 top-0 h-full border-r border-gray-300';
            chartContainer.appendChild(yAxis);
            
            // Add Y-axis labels
            for (let i = 0; i <= maxTasks; i += Math.ceil(maxTasks / 5)) {
                const label = document.createElement('div');
                label.className = 'absolute text-xs text-gray-600';
                label.style.left = '-25px';
                label.style.bottom = `${i * scale}px`;
                label.textContent = `${i}`;
                yAxis.appendChild(label);
            }
            
            // Create bars for each department
            departmentStats.forEach((stat, index) => {
                const barSpacing = 80;
                
                // Total bar
                const totalBarContainer = document.createElement('div');
                totalBarContainer.className = 'relative';
                totalBarContainer.style.left = `${50 + index * (barSpacing * 3 + 20)}px`;
                
                const totalBar = document.createElement('div');
                totalBar.className = 'bar';
                totalBar.style.height = `${stat.total * scale}px`;
                totalBar.style.backgroundColor = '#93c5fd';
                
                const totalValueLabel = document.createElement('div');
                totalValueLabel.className = 'value-label';
                totalValueLabel.textContent = `${stat.total}`;
                
                const deptNameLabel = document.createElement('div');
                deptNameLabel.className = 'bar-label';
                deptNameLabel.textContent = `${stat.name}`;
                
                totalBarContainer.appendChild(totalBar);
                totalBarContainer.appendChild(totalValueLabel);
                totalBarContainer.appendChild(deptNameLabel);
                
                chartContainer.appendChild(totalBarContainer);
                
                // Completed bar
                const completedBarContainer = document.createElement('div');
                completedBarContainer.className = 'relative';
                completedBarContainer.style.left = `${50 + barSpacing + index * (barSpacing * 3 + 20)}px`;
                
                const completedBar = document.createElement('div');
                completedBar.className = 'bar';
                completedBar.style.height = `${stat.completed * scale}px`;
                completedBar.style.backgroundColor = '#4ade80';
                
                const completedValueLabel = document.createElement('div');
                completedValueLabel.className = 'value-label';
                completedValueLabel.textContent = `${stat.completed}`;
                
                const completedNameLabel = document.createElement('div');
                completedNameLabel.className = 'bar-label';
                completedNameLabel.textContent = 'Completed';
                
                completedBarContainer.appendChild(completedBar);
                completedBarContainer.appendChild(completedValueLabel);
                completedBarContainer.appendChild(completedNameLabel);
                
                chartContainer.appendChild(completedBarContainer);
                
                // In Progress bar
                const inProgressBarContainer = document.createElement('div');
                inProgressBarContainer.className = 'relative';
                inProgressBarContainer.style.left = `${50 + barSpacing * 2 + index * (barSpacing * 3 + 20)}px`;
                
                const inProgressBar = document.createElement('div');
                inProgressBar.className = 'bar';
                inProgressBar.style.height = `${stat.inProgress * scale}px`;
                inProgressBar.style.backgroundColor = '#fcd34d';
                
                const inProgressValueLabel = document.createElement('div');
                inProgressValueLabel.className = 'value-label';
                inProgressValueLabel.textContent = `${stat.inProgress}`;
                
                const inProgressNameLabel = document.createElement('div');
                inProgressNameLabel.className = 'bar-label';
                inProgressNameLabel.textContent = 'In Progress';
                
                inProgressBarContainer.appendChild(inProgressBar);
                inProgressBarContainer.appendChild(inProgressValueLabel);
                inProgressBarContainer.appendChild(inProgressNameLabel);
                
                chartContainer.appendChild(inProgressBarContainer);
            });
        }

        function updatePriorityChart() {
            if (!currentUser) return;
            
            const chartContainer = document.getElementById('priorityChart');
            if (!chartContainer) return;
            
            chartContainer.innerHTML = '';
            
            // Calculate tasks by priority
            const priorities = ['low', 'medium', 'high', 'urgent'];
            const priorityCounts = {};
            
            priorities.forEach(priority => {
                const priorityTasks = tasks.filter(task => 
                    task.priority === priority && 
                    task.companyId === currentUser.companyId
                );
                const completedTasks = priorityTasks.filter(task => task.status === 'completed');
                
                priorityCounts[priority] = {
                    total: priorityTasks.length,
                    completed: completedTasks.length
                };
            });
            
            // Find max count for scale
            const maxCount = Math.max(...Object.values(priorityCounts).map(p => p.total), 5);
            const scale = 250 / maxCount;
            
            // Create X and Y axes
            const xAxis = document.createElement('div');
            xAxis.className = 'absolute left-0 bottom-0 w-full border-t border-gray-300';
            chartContainer.appendChild(xAxis);
            
            const yAxis = document.createElement('div');
            yAxis.className = 'absolute left-0 top-0 h-full border-r border-gray-300';
            chartContainer.appendChild(yAxis);
            
            // Add Y-axis labels
            for (let i = 0; i <= maxCount; i += Math.ceil(maxCount / 5)) {
                const label = document.createElement('div');
                label.className = 'absolute text-xs text-gray-600';
                label.style.left = '-25px';
                label.style.bottom = `${i * scale}px`;
                label.textContent = `${i}`;
                yAxis.appendChild(label);
            }
            
            // Color map for priorities
            const priorityColors = {
                'low': '#4ade80',
                'medium': '#93c5fd',
                'high': '#fcd34d',
                'urgent': '#f87171'
            };
            
            // Create bars for each priority
            priorities.forEach((priority, index) => {
                // Total bar
                const totalBarContainer = document.createElement('div');
                totalBarContainer.className = 'relative';
                totalBarContainer.style.left = `${80 + index * 100}px`;
                
                const totalBar = document.createElement('div');
                totalBar.className = 'bar';
                totalBar.style.height = `${priorityCounts[priority].total * scale}px`;
                totalBar.style.backgroundColor = priorityColors[priority];
                
                const totalValueLabel = document.createElement('div');
                totalValueLabel.className = 'value-label';
                totalValueLabel.textContent = `${priorityCounts[priority].total}`;
                
                const priorityNameLabel = document.createElement('div');
                priorityNameLabel.className = 'bar-label';
                priorityNameLabel.textContent = priority.charAt(0).toUpperCase() + priority.slice(1);
                
                totalBarContainer.appendChild(totalBar);
                totalBarContainer.appendChild(totalValueLabel);
                totalBarContainer.appendChild(priorityNameLabel);
                
                chartContainer.appendChild(totalBarContainer);
                
                // Add completion percentage
                if (priorityCounts[priority].total > 0) {
                    const percent = Math.round((priorityCounts[priority].completed / priorityCounts[priority].total) * 100);
                    const percentLabel = document.createElement('div');
                    percentLabel.className = 'text-xs text-center mt-6';
                    percentLabel.textContent = `${percent}% completed`;
                    percentLabel.style.width = '80px';
                    percentLabel.style.position = 'absolute';
                    percentLabel.style.left = `${80 + index * 100 - 20}px`;
                    percentLabel.style.bottom = '-30px';
                    chartContainer.appendChild(percentLabel);
                }
            });
            
            // Add legend
            const legend = document.createElement('div');
            legend.className = 'absolute bottom-16 right-4 bg-white p-2 rounded shadow text-xs';
            legend.innerHTML = `
                <div class="mb-1"><span class="inline-block w-3 h-3 mr-1 bg-green-400"></span> Low Priority</div>
                <div class="mb-1"><span class="inline-block w-3 h-3 mr-1 bg-blue-300"></span> Medium Priority</div>
                <div class="mb-1"><span class="inline-block w-3 h-3 mr-1 bg-yellow-300"></span> High Priority</div>
                <div><span class="inline-block w-3 h-3 mr-1 bg-red-400"></span> Urgent Priority</div>
            `;
            chartContainer.appendChild(legend);
        }

        function updatePerformanceSummary() {
            if (!currentUser) return;
            
            const tableBody = document.getElementById('performanceSummaryTable');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            // Filter employees for the current company
            const companyEmployees = employees.filter(emp => emp.companyId === currentUser.companyId);
            
            companyEmployees.forEach(emp => {
                // Get employee tasks
                const empTasks = tasks.filter(task => 
                    task.companyId === currentUser.companyId &&
                    task.employees && 
                    task.employees.includes(emp.id)
                );
                const completedTasks = empTasks.filter(task => task.status === 'completed');
                const completionRate = empTasks.length > 0 ? Math.round((completedTasks.length / empTasks.length) * 100) : 0;
                
                // Calculate average time to complete (for tasks that have both started and completed dates)
                let avgTimeToComplete = 'N/A';
                const tasksWithDates = completedTasks.filter(task => task.startedAt && task.completedAt);
                
                if (tasksWithDates.length > 0) {
                    const totalTime = tasksWithDates.reduce((sum, task) => {
                        const startTime = new Date(task.startedAt);
                        const endTime = new Date(task.completedAt);
                        return sum + (endTime - startTime);
                    }, 0);
                    
                    const avgTimeMs = totalTime / tasksWithDates.length;
                    const avgTimeHours = Math.round(avgTimeMs / (1000 * 60 * 60) * 10) / 10;
                    avgTimeToComplete = `${avgTimeHours}h`;
                }
                
                // Calculate on-time completion rate
                const onTimeCompletions = completedTasks.filter(task => {
                    const deadlineDate = new Date(task.deadline);
                    const completedDate = new Date(task.completedAt);
                    return completedDate <= deadlineDate;
                });
                
                const onTimeRate = completedTasks.length > 0 ? 
                    Math.round((onTimeCompletions.length / completedTasks.length) * 100) : 0;
                
                // Count revision requests
                const revisionRequests = revisions.filter(rev => {
                    const task = tasks.find(t => 
                        t.id === rev.taskId && 
                        t.companyId === currentUser.companyId
                    );
                    return task && task.employees && task.employees.includes(emp.id);
                });
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-3 px-4">${emp.name}</td>
                    <td class="py-3 px-4">${emp.department || 'Not assigned'}</td>
                    <td class="py-3 px-4">${empTasks.length}</td>
                    <td class="py-3 px-4">${completedTasks.length}</td>
                    <td class="py-3 px-4">${completionRate}%</td>
                    <td class="py-3 px-4">${avgTimeToComplete}</td>
                    <td class="py-3 px-4">${onTimeRate}%</td>
                    <td class="py-3 px-4">${revisionRequests.length}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function filterTasks() {
            updateTaskList();
        }

        function filterEmployeeTasks(filter) {
            const priorityFilter = document.getElementById('empPriorityFilter')
                ? document.getElementById('empPriorityFilter').value
                : 'all';
            displayEmployeeTasks(filter, priorityFilter);
        }

        function toggleNotifications() {
            const dropdown = document.getElementById('notificationsDropdown');
            dropdown.classList.toggle('hidden');
            
            if (!dropdown.classList.contains('hidden')) {
                // Update notifications list
                updateNotificationsList(currentUser.email, 'notificationsList');
            }
        }

        function toggleEmployeeNotifications() {
            const dropdown = document.getElementById('employeeNotificationsDropdown');
            dropdown.classList.toggle('hidden');
            
            if (!dropdown.classList.contains('hidden')) {
                // Update notifications list
                updateNotificationsList(currentUser.email, 'employeeNotificationsList');
            }
        }

        function updateNotificationsList(userEmail, listId) {
            if (!currentUser) return;
            
            const notificationsList = document.getElementById(listId);
            if (!notificationsList) return;
            
            // Filter notifications for this user and company
            const userNotifications = notifications.filter(n => 
                n.user === userEmail && 
                (!n.companyId || n.companyId === currentUser.companyId)
            );
            
            if (userNotifications.length === 0) {
                notificationsList.innerHTML = '<p class="text-gray-500 text-sm p-2">No new notifications</p>';
                return;
            }
            
            notificationsList.innerHTML = '';
            
            // Sort notifications by timestamp (newest first)
            userNotifications.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            userNotifications.forEach(notification => {
                const notificationElement = document.createElement('div');
                notificationElement.className = `p-2 ${notification.read ? 'bg-gray-50' : 'bg-blue-50'} border-b`;
                
                let viewTaskButton = '';
                if (notification.taskId) {
                    viewTaskButton = `
                        <button onclick="viewTaskFromNotification(${notification.taskId})" class="text-xs text-blue-500 hover:underline">
                            View Task
                        </button>
                    `;
                }
                
                notificationElement.innerHTML = `
                    <div class="flex justify-between">
                        <p class="${notification.read ? 'text-gray-600' : 'text-gray-800 font-semibold'}">${notification.message}</p>
                        <button onclick="markNotificationAsRead(${notification.id})" class="text-xs text-blue-500">
                            ${notification.read ? '' : 'Mark read'}
                        </button>
                    </div>
                    <div class="flex justify-between items-center mt-1">
                        <p class="text-xs text-gray-500">${new Date(notification.timestamp).toLocaleString()}</p>
                        ${viewTaskButton}
                    </div>
                `;
                notificationsList.appendChild(notificationElement);
            });
            
            // Update badge
            const unreadCount = userNotifications.filter(n => !n.read).length;
            const badgeId = listId === 'notificationsList' ? 'notificationBadge' : 'employeeNotificationBadge';
            const badge = document.getElementById(badgeId);
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function viewTaskFromNotification(taskId) {
            // Close notifications dropdown
            document.getElementById('notificationsDropdown').classList.add('hidden');
            document.getElementById('employeeNotificationsDropdown').classList.add('hidden');
            
            // View task details
            viewTaskDetails(taskId, currentUser.role === 'admin');
        }

        function updateAdminNotifications() {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            // Update notification badge for admin user
            const adminNotifications = notifications.filter(n => 
                n.user === currentUser.email && 
                !n.read && 
                (!n.companyId || n.companyId === currentUser.companyId)
            );
            
            const badge = document.getElementById('notificationBadge');
            
            if (adminNotifications.length > 0 && badge) {
                badge.textContent = adminNotifications.length;
                badge.classList.remove('hidden');
            } else if (badge) {
                badge.classList.add('hidden');
            }
        }

        function updateEmployeeNotifications(email) {
            if (!email) return;
            
            // If this is the current user, update their notification badge
            if (currentUser && currentUser.email === email) {
                const employeeNotifications = notifications.filter(n => 
                    n.user === email && 
                    !n.read && 
                    (!n.companyId || n.companyId === currentUser.companyId)
                );
                
                const badge = document.getElementById('employeeNotificationBadge');
                
                if (badge && employeeNotifications.length > 0) {
                    badge.textContent = employeeNotifications.length;
                    badge.classList.remove('hidden');
                } else if (badge) {
                    badge.classList.add('hidden');
                }
            }
        }

        function markNotificationAsRead(notificationId) {
            const notificationIndex = notifications.findIndex(n => n.id === notificationId);
            if (notificationIndex !== -1) {
                notifications[notificationIndex].read = true;
                localStorage.setItem('taskManagementNotifications', JSON.stringify(notifications));
                
                // Update the list
                const listId = currentUser.role === 'admin' ? 'notificationsList' : 'employeeNotificationsList';
                updateNotificationsList(currentUser.email, listId);
            }
        }

        function viewTaskDetails(taskId, isAdmin) {
            const task = tasks.find(t => t.id === taskId && t.companyId === currentUser.companyId);
            if (!task) return;
            
            // Set current task ID for comments
            currentTaskId = taskId;
            
            // Get the modal elements
            const modal = document.getElementById('taskModal');
            const modalTitle = document.getElementById('modalTaskTitle');
            const modalContent = document.getElementById('taskModalContent');
            const commentsList = document.getElementById('commentsList');
            
            // Show or hide revision request form based on role and task status
            const revisionForm = document.getElementById('taskRevisionRequest');
            if (!isAdmin && task.status !== 'completed' && task.status !== 'revision-requested') {
                revisionForm.classList.remove('hidden');
                
                // Set default new deadline value (1 day later than current)
                const currentDeadline = new Date(task.deadline);
                const newDeadline = new Date(currentDeadline);
                newDeadline.setDate(newDeadline.getDate() + 1);
                
                // Format for datetime-local input
                const formattedDate = newDeadline.toISOString().slice(0, 16);
                document.getElementById('newDeadline').value = formattedDate;
            } else {
                revisionForm.classList.add('hidden');
            }
            
            // Update modal title
            modalTitle.textContent = task.title;
            
            // Get assigned employees names
            const assignedEmployees = task.employees 
                ? task.employees.map(empId => {
                    const emp = employees.find(e => e.id === empId && e.companyId === currentUser.companyId);
                    return emp ? emp.name : 'Unknown';
                  }).join(', ')
                : 'Unknown';
            
            const deadlineDate = new Date(task.deadline);
            const isOverdue = deadlineDate < new Date() && task.status !== 'completed';
            
            const priorityColors = {
                low: 'bg-green-100 text-green-800',
                medium: 'bg-blue-100 text-blue-800',
                high: 'bg-orange-100 text-orange-800',
                urgent: 'bg-red-100 text-red-800'
            };
            
            const statusColors = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'in-progress': 'bg-blue-100 text-blue-800',
                'completed': 'bg-green-100 text-green-800',
                'overdue': 'bg-red-100 text-red-800',
                'revision-requested': 'bg-purple-100 text-purple-800'
            };
            
            // Fill modal content
            modalContent.innerHTML = `
                <div class="space-y-4">
                    <div class="flex flex-wrap gap-2">
                        <span class="px-2 py-1 rounded text-xs ${priorityColors[task.priority]}">Priority: ${task.priority}</span>
                        <span class="px-2 py-1 rounded text-xs ${statusColors[isOverdue ? 'overdue' : task.status]}">
                            Status: ${isOverdue ? 'Overdue' : task.status.replace('-', ' ')}
                        </span>
                        <span class="px-2 py-1 rounded text-xs bg-gray-100 text-gray-800">
                            Department: ${task.department || 'Not specified'}
                        </span>
                    </div>
                    
                    <p>${task.description}</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-semibold">Assigned to</h4>
                            <p>${assignedEmployees}</p>
                        </div>
                        <div>
                            <h4 class="font-semibold">Hours Allocation</h4>
                            <p>${task.hours} hours</p>
                        </div>
                        <div>
                            <h4 class="font-semibold">Deadline</h4>
                            <p>${new Date(task.deadline).toLocaleString()}</p>
                        </div>
                        <div>
                            <h4 class="font-semibold">Frequency</h4>
                            <p>${task.frequency}</p>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold">Timeline</h4>
                        <ul class="ml-5 space-y-1 list-disc">
                            <li>Created: ${new Date(task.createdAt).toLocaleString()}</li>
                            ${task.startedAt ? `<li>Started: ${new Date(task.startedAt).toLocaleString()}</li>` : ''}
                            ${task.completedAt ? `<li>Completed: ${new Date(task.completedAt).toLocaleString()}</li>` : ''}
                        </ul>
                    </div>
                    
                    ${isAdmin ? `
                        <div class="flex flex-wrap gap-2 mt-4">
                            <button onclick="editTask(${task.id})" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">
                                <i class="bi bi-pencil"></i> Edit Task
                            </button>
                            <select onchange="changeTaskStatusFromModal(${task.id}, this.value)" class="bg-gray-200 px-3 py-1 rounded">
                                <option value="">Change Status</option>
                                <option value="pending">Pending</option>
                                <option value="in-progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="revision-requested">Revision Requested</option>
                            </select>
                        </div>
                    ` : task.status !== 'completed' ? `
                        <div class="flex flex-wrap gap-2 mt-4">
                            ${task.status === 'pending' ? 
                                `<button onclick="startTask(${task.id})" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">
                                    <i class="bi bi-play-fill"></i> Start Task
                                </button>` : ''
                            }
                            ${task.status === 'in-progress' ? 
                                `<button onclick="completeTask(${task.id})" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">
                                    <i class="bi bi-check-lg"></i> Complete Task
                                </button>` : ''
                            }
                            <select onchange="updateTaskStatus(${task.id}, this.value)" class="bg-gray-200 px-3 py-1 rounded">
                                <option value="">Change Status</option>
                                <option value="pending" ${task.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="in-progress" ${task.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>Completed</option>
                            </select>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Fill comments section
            renderComments(task);
            
            // Show the modal
            modal.classList.remove('hidden');
            
            // Mark comments as read
            if (task.comments) {
                let updated = false;
                task.comments.forEach(comment => {
                    if (!comment.read && comment.authorEmail !== currentUser.email) {
                        comment.read = true;
                        updated = true;
                    }
                });
                
                if (updated) {
                    localStorage.setItem('taskManagementTasks', JSON.stringify(tasks));
                    // Update task list to refresh unread comment indicators
                    if (isAdmin) {
                        updateTaskList();
                    } else {
                        if (document.getElementById('empPriorityFilter')) {
                            const priorityFilter = document.getElementById('empPriorityFilter').value;
                            displayEmployeeTasks('all', priorityFilter);
                        } else {
                            displayEmployeeTasks('all');
                        }
                    }
                }
            }
        }

        function changeTaskStatusFromModal(taskId, newStatus) {
            if (newStatus) {
                changeTaskStatus(taskId, newStatus);
                closeTaskModal();
            }
        }

        function renderComments(task) {
            const commentsList = document.getElementById('commentsList');
            commentsList.innerHTML = '';
            
            if (!task.comments || task.comments.length === 0) {
                commentsList.innerHTML = '<p class="text-center text-gray-500">No comments yet</p>';
                return;
            }
            
            // Sort comments chronologically
            task.comments.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            task.comments.forEach(comment => {
                const isCurrentUser = comment.authorEmail === currentUser.email;
                
                const commentElement = document.createElement('div');
                commentElement.className = `p-3 rounded ${isCurrentUser ? 'bg-blue-50 ml-8' : 'bg-gray-50 mr-8'}`;
                commentElement.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-semibold">${comment.author}</span>
                        <span class="text-xs text-gray-500">${new Date(comment.timestamp).toLocaleString()}</span>
                    </div>
                    <p class="mt-1">${comment.text}</p>
                `;
                commentsList.appendChild(commentElement);
            });
        }

        function closeTaskModal() {
            document.getElementById('taskModal').classList.add('hidden');
            currentTaskId = null;
        }

        function handleNewComment(e) {
            e.preventDefault();
            
            if (!currentTaskId) return;
            
            const commentText = document.getElementById('commentText').value.trim();
            if (!commentText) return;
            
            const task = tasks.find(t => t.id === currentTaskId && t.companyId === currentUser.companyId);
            if (!task) return;
            
            // Initialize comments array if it doesn't exist
            if (!task.comments) task.comments = [];
            
            // Add new comment
            const newComment = {
                id: Date.now(),
                author: currentUser.name,
                authorEmail: currentUser.email,
                text: commentText,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            task.comments.push(newComment);
            
            // Save to localStorage
            localStorage.setItem('taskManagementTasks', JSON.stringify(tasks));
            
            // Refresh comments list
            renderComments(task);
            
            // Clear input field
            document.getElementById('commentText').value = '';
            
            // Create notification for the other parties
            if (currentUser.role === 'admin') {
                // Notify all assigned employees
                if (task.employees) {
                    task.employees.forEach(empId => {
                        const employee = employees.find(e => e.id === empId && e.companyId === currentUser.companyId);
                        if (employee) {
                            notifications.push({
                                id: Date.now() + Math.random(),
                                user: employee.email,
                                message: `Admin commented on task "${task.title}"`,
                                timestamp: new Date().toISOString(),
                                read: false,
                                taskId: currentTaskId,
                                companyId: currentUser.companyId
                            });
                            updateEmployeeNotifications(employee.email);
                        }
                    });
                }
            } else {
                // Find the admin(s) for this company
                const adminEmails = Object.entries(users)
                    .filter(([_, user]) => user.role === 'admin' && user.companyId === currentUser.companyId)
                    .map(([email, _]) => email);
                
                adminEmails.forEach(adminEmail => {
                    notifications.push({
                        id: Date.now() + Math.random(),
                        user: adminEmail,
                        message: `${currentUser.name} commented on task "${task.title}"`,
                        timestamp: new Date().toISOString(),
                        read: false,
                        taskId: currentTaskId,
                        companyId: currentUser.companyId
                    });
                });
                
                updateAdminNotifications();
            }
            
            localStorage.setItem('taskManagementNotifications', JSON.stringify(notifications));
        }

        function showRevisionForm(taskId) {
            currentTaskId = taskId;
            viewTaskDetails(taskId, false);
            
            // Focus on the revision section
            document.getElementById('taskRevisionRequest').scrollIntoView({ behavior: 'smooth' });
        }

        function handleRevisionRequest(e) {
            e.preventDefault();
            
            if (!currentTaskId) return;
            
            const newDeadline = document.getElementById('newDeadline').value;
            const reason = document.getElementById('revisionReason').value;
            
            if (!newDeadline || !reason) {
                alert("Please fill in all fields.");
                return;
            }
            
            const task = tasks.find(t => t.id === currentTaskId && t.companyId === currentUser.companyId);
            if (!task) return;
            
            // Create revision request
            const revisionRequest = {
                id: Date.now(),
                taskId: currentTaskId,
                employeeId: currentUser.id,
                oldDeadline: task.deadline,
                requestedDeadline: newDeadline,
                reason: reason,
                status: 'pending', // pending, approved, rejected
                timestamp: new Date().toISOString(),
                companyId: currentUser.companyId
            };
            
            revisions.push(revisionRequest);
            localStorage.setItem('taskManagementRevisions', JSON.stringify(revisions));
            
            // Update task status
            task.status = 'revision-requested';
            localStorage.setItem('taskManagementTasks', JSON.stringify(tasks));
            
            // Find the admin(s) for this company
            const adminEmails = Object.entries(users)
                .filter(([_, user]) => user.role === 'admin' && user.companyId === currentUser.companyId)
                .map(([email, _]) => email);
            
            adminEmails.forEach(adminEmail => {
                notifications.push({
                    id: Date.now() + Math.random(),
                    user: adminEmail,
                    message: `${currentUser.name} requested a deadline revision for task "${task.title}"`,
                    timestamp: new Date().toISOString(),
                    read: false,
                    taskId: currentTaskId,
                    companyId: currentUser.companyId
                });
            });
            
            localStorage.setItem('taskManagementNotifications', JSON.stringify(notifications));
            updateAdminNotifications();
            
            // Add comment about the revision request
            if (!task.comments) task.comments = [];
            
            task.comments.push({
                id: Date.now(),
                author: currentUser.name,
                authorEmail: currentUser.email,
                text: `Requested deadline revision from ${new Date(task.deadline).toLocaleString()} to ${new Date(newDeadline).toLocaleString()}. Reason: ${reason}`,
                timestamp: new Date().toISOString(),
                read: false
            });
            
            localStorage.setItem('taskManagementTasks', JSON.stringify(tasks));
            
            alert("Revision request submitted. The task status has been updated to 'Revision Requested'.");
            closeTaskModal();
            
            // Update employee's task list
            const priorityFilter = document.getElementById('empPriorityFilter') 
                ? document.getElementById('empPriorityFilter').value
                : 'all';
            displayEmployeeTasks('all', priorityFilter);
        }

        function handleFileUpload(e) {
            const fileName = e.target.files[0]?.name || "No file selected";
            document.getElementById('fileName').textContent = fileName;
            
            // In a real implementation, you would use a library like SheetJS to parse the Excel file
            // For this prototype, we'll simulate success
            if (e.target.files.length > 0) {
                setTimeout(() => {
                    alert('File uploaded! In a real implementation, this would process the Excel file to extract emails.');
                }, 1000);
            }
        }

        function scrapeUrl() {
            const url = document.getElementById('manualUrl').value;
            if (!url) {
                alert('Please enter a URL');
                return;
            }
            
            // In a real implementation, this would call a backend service to scrape the URL
            // For this prototype, we'll simulate success with random data
            const resultsTable = document.getElementById('scrapingResults');
            
            // Clear any "no results" message
            if (resultsTable.innerHTML.includes('Results will appear here')) {
                resultsTable.innerHTML = '';
            }
            
            // Add a loading row
            const loadingRow = document.createElement('tr');
            loadingRow.id = 'loadingRow';
            loadingRow.innerHTML = `
                <td colspan="4" class="text-center p-4">
                    <div class="flex justify-center">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
                    </div>
                    <p class="mt-2">Scraping URL...</p>
                </td>
            `;
            resultsTable.appendChild(loadingRow);
            
            // Simulate API call delay
            setTimeout(() => {
                // Remove loading row
                document.getElementById('loadingRow').remove();
                
                // Generate a fake email or show error
                const success = Math.random() > 0.3; // 70% success rate
                const row = document.createElement('tr');
                
                if (success) {
                    const domain = url.includes('linkedin.com') ? 'linkedin' : 'example';
                    const randomName = ['john.doe', 'jane.smith', 'mike.johnson', 'sarah.williams'][Math.floor(Math.random() * 4)];
                    const randomEmail = `${randomName}@${domain}.com`;
                    const name = randomName.split('.').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                    
                    row.innerHTML = `
                        <td class="p-2 border">${url}</td>
                        <td class="p-2 border">${randomEmail}</td>
                        <td class="p-2 border">${name}</td>
                        <td class="p-2 border text-green-500">Success</td>
                    `;
                } else {
                    row.innerHTML = `
                        <td class="p-2 border">${url}</td>
                        <td class="p-2 border">-</td>
                        <td class="p-2 border">-</td>
                        <td class="p-2 border text-red-500">Failed to extract email</td>
                    `;
                }
                
                resultsTable.appendChild(row);
                document.getElementById('manualUrl').value = '';
            }, 2000);
        }

        function exportToCsv() {
            // In a real implementation, this would generate and download a CSV file
            alert('In a real implementation, this would download a CSV file of the results.');
        }

        function clearScrapingResults() {
            document.getElementById('scrapingResults').innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-gray-500 p-4">Results will appear here</td>
                </tr>
            `;
        }

        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            
            // Hide all dashboards
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('signupSection').classList.add('hidden');
            document.getElementById('masterDashboard').classList.add('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('employeeDashboard').classList.add('hidden');
            
            // Hide all modals
            document.getElementById('taskModal').classList.add('hidden');
            document.getElementById('departmentModal').classList.add('hidden');
            document.getElementById('calendarTaskModal').classList.add('hidden');
            
            // Reset forms
            document.getElementById('loginForm').reset();
            
            // Clear selected employees list
            selectedEmployees = [];
        }

        // Check for tasks that need reminders
        setInterval(() => {
            if (!currentUser) return;
            
            const now = new Date();
            tasks.filter(task => task.companyId === currentUser.companyId).forEach(task => {
                const deadline = new Date(task.deadline);
                const timeDiff = deadline - now;
                
                // Send reminder if less than 1 hour before deadline and task is not completed
                if (task.sendReminder && task.status !== 'completed' && 
                    timeDiff > 0 && timeDiff <= 3600000) {
                    
                    // For admin, show all reminders
                    if (currentUser.role === 'admin') {
                        // Find all employee names for the task
                        let employeeNames = "Unknown";
                        if (task.employees && task.employees.length > 0) {
                            employeeNames = task.employees.map(empId => {
                                const emp = employees.find(e => e.id === empId && e.companyId === currentUser.companyId);
                                return emp ? emp.name : "Unknown";
                            }).join(", ");
                        }
                        
                        alert(`Reminder: Task "${task.title}" assigned to ${employeeNames} is due in less than an hour!`);
                    } 
                    // For employees, only show their own reminders
                    else if (currentUser.role === 'employee' && 
                            task.employees && task.employees.includes(currentUser.id)) {
                        alert(`Reminder: Your task "${task.title}" is due in less than an hour!`);
                    }
                }
            });
        }, 300000); // Check every 5 minutes
    </script>
<script>document.body.addEventListener('wheel', e => { if (!e.ctrlKey) return; e.preventDefault(); return }, { passive: false })</script>
	</body>
</html>